\documentclass[preprint,aps,pra,onecolumn,superscriptaddress]{revtex4-1} %reprint
%\tightenlines

%\draft
\usepackage{etex}
\usepackage{amsmath}
\usepackage{bm}
\usepackage{bbm}
\usepackage{listings}
% % \textwidth 16cm \textheight 23.5cm
% \renewcommand{\baselinestretch}{1.2}
\usepackage{graphicx}
\usepackage{graphics}
\usepackage{epsfig}
\usepackage{color}
\usepackage[dvipsnames]{xcolor}
\usepackage{multirow}
\usepackage[colorlinks]{hyperref}
\usepackage{fancyhdr}
\usepackage{calc}
\usepackage{natbib} %[numbers]
\usepackage{bibentry}
\usepackage{bbm}

% todo list and commands
%\usepackage{todonotes}
%% to avoid the conflict with amths package % not working
%\makeatletter
%\providecommand\@dotsep{5}
%\makeatother
%\listoftodos\relax
%\usepackage{makeidx}
%\allowdisplaybreaks
%% for eps transfering to pdf.
%\usepackage[update,prepend]{epstopdf}
%\usepackage{ifpdf}
%
%\ifpdf
%   \usepackage{graphicx}
%   \usepackage{epstopdf}
%   \epstopdfsetup{suffix=}
%   \DeclareGraphicsRule{.eps}{pdf}{.pdf}{`epstopdf #1}
%   \pdfcompresslevel=9
%\else
%   \usepackage{graphicx}
%\fi
% subfig
\usepackage{mwe}
\usepackage{subfig}
% to fix a figure's position using [H] option of thec figure.
\usepackage{float}
% to use \lesssim and other math symbols
%\usepackage{amssymb}
% set package options
\captionsetup[subfloat]{position=top,singlelinecheck=off,labelfont={normalsize,sf}, %justification=raggedright,
  labelformat=simple,listofformat=subparens,aboveskip=0pt,parskip=0pt,farskip=5pt,
  captionskip=0pt}

% customize subfigure label to capitals
\renewcommand{\thesubfigure}{(\alph{subfigure})}

% self-defined short-cuts and commands
%\input{Mydef.tex}
\DeclareMathOperator{\tr}{tr}
\newcommand{\dt}[1]{\frac{{\mathrm d} {#1}}{{\mathrm d}t}}
\def\br{\mathbf{r}}
\def\bra#1{\langle{#1}\rvert}%{\mathinner{\langle{#1}\rvert}}
\def\ket#1{\lvert{#1}\rangle}%{\mathinner{\lvert{#1}\rangle}}
\def\Braket#1#2{\mathinner{\langle{#1}\! \mid\! {#2} \rangle}}
%========================================================================================
\newcommand{\erf}[1]{Eq.~(\ref{#1})}
\newcommand{\frf}[1]{Fig.~\ref{#1}}
\newcommand{\srf}[1]{Sec.~\ref{#1}}
\newcommand{\nn}{\nonumber}
\newcommand{\mbf}[1]{\mathbf{#1}}
%========================================================================================
% General quantum mechanics macros
%========================================================================================
\newcommand{\op}[2]{\ket{#1}\bra{#2}}
\newcommand{\expt}[1]{\langle{#1}\rangle}
\newcommand{\dg}{^\dagger}
\newcommand{\smallfrac}[2]{\mbox{$\frac{#1}{#2}$}}
\newcommand{\Tr}{\mbox{Tr}}
%========================================================================================
\newcommand{\expect}[1]{\big\langle #1 \big\rangle}
\newcommand{\eff}{\text{eff}}



% Redefine the tensor command.
%\renewcommand{\tensor}[1]{\boldsymbol{#1}}


%==== Ben's new macros ======
%\newcommand{\srf}[1]{Sec. \ref{#1}}
\newcommand{\half}{\smallfrac{1}{2}}

%==== subscripts ======
\newcommand{\oneD}{{\rm 1D}}
\newcommand{\vac}{{\rm vac}}
\newcommand{\cav}{{\rm cav}}
\newcommand{\inp}{{\rm in}}
\newcommand{\out}{{\rm out}}
\newcommand{\inter}{{\rm int}}
\newcommand{\scs}{{\rm SCS}}
\newcommand{\fwd}{+}
\newcommand{\bwd}{-}
\newcommand{\trans}{+}
\newcommand{\refl}{-}

 %==== operators/moments ======
\newcommand{\der}[1]{\frac{d {#1}}{dt}}
\newcommand{\unittens}{\tensor{\mathbf{I}}}
\newcommand{\poltens}{\hat{\tensor{\boldsymbol{\alpha}}}}
\newcommand{\varz}{\Delta J_3^2}
\newcommand{\jx}{\hat{J}_1}
\newcommand{\jz}{\hat{J}_3}
\newcommand{\shotnoise}{\Delta \mathcal{M}^2 |_{\rm SN}}
\newcommand{\projnoise}{\Delta \mathcal{M}^2_{\rm PN}}
\newcommand{\polcomp}{\hat{K}} % p,p' component of the tensor polarizability
\newcommand{\fo}{\hat{\mathbf{f}}}
\newcommand{\fx}{\hat{f}_x}
\newcommand{\fy}{\hat{f}_y}
\newcommand{\fz}{\hat{f}_z}
\newcommand{\Fx}{\hat{F}_x}
\newcommand{\Fy}{\hat{F}_y}
\newcommand{\Fz}{\hat{F}_z}
\newcommand{\rhoo}{\hat{\rho}}

%==== Microscopic moments for the qubit/qutrit subspace ====
\newcommand{\sigmauu}{\hat{\sigma}_{\uparrow\uparrow}}
\newcommand{\sigmaud}{\hat{\sigma}_{\uparrow\downarrow}}
\newcommand{\sigmaut}{\hat{\sigma}_{\uparrow \mathrm{T}}}
\newcommand{\sigmadu}{\hat{\sigma}_{\downarrow\uparrow}}
\newcommand{\sigmadd}{\hat{\sigma}_{\downarrow\downarrow}}
\newcommand{\sigmadt}{\hat{\sigma}_{\downarrow \mathrm{T}}}
\newcommand{\sigmatu}{\hat{\sigma}_{\mathrm{T}\uparrow}}
\newcommand{\sigmatd}{\hat{\sigma}_{\mathrm{T}\downarrow}}
\newcommand{\sigmatt}{\hat{\sigma}_{\mathrm{T}\mathrm{T}}}
\newcommand{\sigmaab}{\hat{\sigma}_{ab}}
\newcommand{\sigmaba}{\hat{\sigma}_{ba}}
\newcommand{\sigmadc}{\hat{\sigma}_{dc}}
\newcommand{\sigmacd}{\hat{\sigma}_{cd}}

\newcommand{\Dsigmauu}{\Delta\sigma_{\uparrow\uparrow}}
\newcommand{\Dsigmaud}{\Delta\sigma_{\uparrow\downarrow}}
\newcommand{\Dsigmaut}{\Delta\sigma_{\uparrow \mathrm{T}}}
\newcommand{\Dsigmadu}{\Delta\sigma_{\downarrow\uparrow}}
\newcommand{\Dsigmadd}{\Delta\sigma_{\downarrow\downarrow}}
\newcommand{\Dsigmadt}{\Delta\sigma_{\downarrow \mathrm{T}}}
\newcommand{\Dsigmatu}{\Delta\sigma_{\mathrm{T}\uparrow}}
\newcommand{\Dsigmatd}{\Delta\sigma_{\mathrm{T}\downarrow}}
\newcommand{\Dsigmatt}{\Delta\sigma_{\mathrm{T}\mathrm{T}}}
\newcommand{\Dsigmaab}{\Delta\sigma_{ab}}
\newcommand{\Dsigmaba}{\Delta\sigma_{ba}}
\newcommand{\Dsigmadc}{\Delta\sigma_{dc}}
\newcommand{\Dsigmacd}{\Delta\sigma_{cd}}

%==== physical parameters ======
\newcommand{\Eamp}{\mathcal{F}_0^{(+)}}
\newcommand{\charpol}{\alpha_0(\Delta_{f\!f'})}
\newcommand{\charpolq}{\alpha_0(\Delta_{f\!f'}^q)}
\newcommand{\qaxis}{\mathbf{e}_{\tilde{z}}}
\newcommand{\qangle}{\varphi}
\newcommand{\magic}[1]{\tilde{\omega}_{#1}}
\newcommand{\chiN}{\chi_{N}}
\newcommand{\NA}{N_C}
\newcommand{\chieff}{\chi_{\raisebox{-.1pt}{\tiny $J_3$}}}

%==== scattering and optical pumping rates ====%
\newcommand{\gammauu}{\gamma_{\uparrow \rightarrow \uparrow}}
\newcommand{\gammadd}{\gamma_{\downarrow \rightarrow \downarrow}}
\newcommand{\gammaud}{\gamma_{\uparrow \rightarrow \downarrow}}
\newcommand{\gammadu}{\gamma_{\downarrow \rightarrow \uparrow}}
\newcommand{\gammau}{\gamma_{\uparrow}}
\newcommand{\gammad}{\gamma_{\downarrow}}

%==== effective areas ======
\newcommand{\Ain}{A_{\rm in}}
\newcommand{\Abir}{A_N}
\newcommand{\AF}{A_{\rm Far}} % for the Faraday protocol.
\newcommand{\Ai}{A_{\rm in}} % for the input light.
\newcommand{\Aint}{A_{\rm int}} % for the interaction area.

%==== eigenfunctions ======
\newcommand{\eigenf}{\mbf{f}_\eta}
\newcommand{\eigenfp}{\mbf{f}_{\eta'}}
\newcommand{\eigeng}{\mbf{g}_\eta}
\newcommand{\eigengp}{\mbf{g}_{\eta'}}

%==== field operators ======
\newcommand{\awg}{\hat{a}_{b,p}(\omega)}
\newcommand{\awr}{\hat{a}_{m,p}(\omega,\beta)}

%==== Famous names ======
\usepackage{xspace}
\newcommand{\Poincare}{Poincar\'e\xspace}
\newcommand{\sch}{Schr\"odinger\xspace}

%==== colors for editing ======
\newcommand{\change}[1]{{\color{RoyalBlue} #1}}
\newcommand{\comment}[1]{{\color{Maroon} #1}}
\newcommand{\error}[1]{{\color{red} #1}}

% =============================================================================


\begin{document}
\title{Enhanced cooperativity for QND measurement-induced spin squeezing of atoms coupled to a nanophotonic waveguide}
\author{Xiaodong Qi}
\affiliation{Center for Quantum Information and Control, University of New Mexico, Albuquerque, New Mexico 87131, USA}
\author{Yuan-Yu Jau}
\affiliation{Center for Quantum Information and Control, Sandia National Laboratories, Albuquerque, New Mexico 87185, USA}
\author{Ivan H. Deutsch}
\affiliation{Center for Quantum Information and Control, University of New Mexico, Albuquerque, New Mexico 87131, USA}
\date{\today}
\pacs{42.50.Lc, 03.67.Bg, 42.50.Dv, 42.81.Gs}

%================================================================%
\begin{abstract}
We study the enhancement of cooperativity in the atom-light interface near a nanophotonic waveguide for application to QND measurement of atomic spins.  Here the cooperativity per atom is determined by the ratio between the  measurement strength and the decoherence rate.  Counterintuitively, we find that by placing the atoms at an azimuthal position where the guided probe mode has the lowest intensity, we increase the cooperativity.  This arises because the QND measurement strength depends on the interference between the probe and scattered light guided into an orthogonal polarization mode, while the decoherence rate depends on the local intensity of the probe.  Thus, by proper choice of geometry, the ratio of good to bad scattering can be strongly enhanced for highly anisotropic modes. We apply this to study spin squeezing resulting from QND measurement of spin projection noise via the Faraday effect in two nanophotonic geometries, a cylindrical nanofiber and square waveguide (SWG).  We find, with about 2500 atoms using realistic experimental parameters, $ \sim 7.1 $dB and $ \sim 13.5 $dB of squeezing can be achieved on the nanofiber and SWG, respectively. This result facilitates quantum information protocols based on strong atom-light coupling on nanophotonic interfaces while minimizes the mechanical disturb due to the presence of a probe light. 
\end{abstract}

\maketitle

%===================INTRODUCTION=====================%
\section{Introduction}

Cooperativity is the essential measure of the entangling strength of the atom-light interface in quantum optics.  Originally introduced in cavity QED, the cooperativity per atom can be expressed in terms of the ratio of the coherent coupling to decoherence rate, $C_1 = g^2/(\Gamma_c \Gamma_A)$ where $g$ is the vacuum Rabi frequency,  $\Gamma_c$ is the cavity decay rate, and $\Gamma_A$ is atomic spontaneous emission rate out of the cavity.  Alternatively, we can write $C_1 = (\sigma_0/A) \mathcal{F}$, where $\sigma_0$ is the resonant photon scattering cross section of the atom, $A$ is the cavity mode area, and $\mathcal{F}$ is the cavity finesse.  Expressed this way, cooperativity is seen to arise due to scattering of photons preferentially into the cavity mode, compared to emission into free space, here enhanced by the finesses due to the Purcell effect. Strong coupling dynamics seen in pioneering in atomic cavity QED~\cite{Aoki2006,Miller2005} is now a mainstay in quantum information processing in systems ranging from quantum dots~\cite{Akimov2007,Akopian2006,Liu2010} to circuit QED~\cite{Wallraff2004Strong,Vlastakis2013,Tosi2014}.  The $N_A$ atom cooperativity, $C_N = (N_A \sigma_0/A) \mathcal{F} =( OD) \mathcal{F}$, where $OD$ is the resonant optical depth.  In this configuration, collective degrees of the atom can be manipulated by its common coupling to the cavity mode.

Cooperativity also characterizes the atom-light interface in the absence of a cavity.  In free space, an atom at the waist of a laser beam will scatter into the forward direction at a rate $\kappa = (\sigma_0/A) \gamma_s$, where $\gamma_s$ is the photon scattering rate into $4 \pi$ steradians.  Here the single atom cooperativity can be expressed as the ratio of these rates, $C_1 = \kappa/\gamma_s = \sigma_0/A$.  The $N_A$-atom cooperativity, in a plane wave approximation, ignoring effects of diffraction and cloud geometry, $C_N = N_A \sigma_0/A = OD$.  To be self-consistent, here the beam area must be very large, so $C_1$ is very small, e.g. $C_1 \sim 10^{-6}$, but for a sufficiently large ensemble, the $OD$ can be large enough to lead to entanglement between the collective atomic degrees of freedom and the light~\cite{Kuzmich1998,Takahashi1999Quantum}.  In that situation, measurement of the light leads to back action on the ensemble, and for an appropriate QND interaction, results in squeezing of the collective spin~\cite{Madsen2004Spin,Kuzmich2000}.

In recent years, nanophotonic waveguides have emerged as a new geometry that complements cavity QED, and can lead to strong cooperativity~\cite{Yu2014,Hung2013,Goban2014,Goban2012,Sayrin2015,Sayrin2015a}.  Notably, the effective area of a tightly guided mode can be much smaller than free space and propagate for long distances without diffraction.  As such,  $\sigma_0/A$ can be orders of magnitude larger than in free space, e.g., $\sigma_0/A \sim 0.1$, and contribute collectively for a modest ensemble of a few thousand atoms trapped near the surface of the waveguide.  Moreover, in some cases the Purcell effect can further enhance forward scattering into the guided mode when compared with scattering into free space.  Taken together, these features make  nanophotonic waveguides a promising platform for a quantum atom-light interface~\cite{Douglas2015,Chang2013,Asenjo-Garcia2017Exponential,Vetsch2010Optical,Dawkins2011,Qi2016}.
 
In this paper we show that one can achieve an additional enhancement to the cooperativity in a nanophotonic geometry that is not possible in free space. In particular, we consider the QND measurement of the collective spin of an atomic ensemble via a Faraday interaction followed by polarization spectroscopy.  In this configuration the polarimeter effectively performs a homodyne measurement, where the probe is the ``local oscillator" that interferes with the light scattered into the orthogonally polarized guided mode.   This signal thus depends on the spatial overlap of the two orthogonal modes at the position of the atom.  In contrast, decoherence due to photon scattering into unguided $4 \pi$ steradians occurs at a rate $\gamma_s$ is determined only by the intensity of the probe.   The net result is that cooperativity per atom, $C_1 = \kappa/\gamma_s$, primarily depends on the strength of the orthogonal mode, and this factor can be enhanced, especially for highly anisotropic guided modes.  Counterintuitively, we will see that the strongest cooperativity arises when the atom is placed at the position of  minimum intensity of the azimuthally anisotropic probe mode where the intensity of the initially unoccupied orthogonal mode is maximum. This feature could also help reduce the perturbation on the motion of trapped atoms due to the probe that causes a disturbance in the signal~\cite{Solano2017Dynamics}.  

We study the enhanced cooperativity for two nanophotonic geometries: a cylindrical nanofiber formed by tapering a standard optical fiber, as recently employed in a variety of experimental studies~\cite{Nayak2008,Vetsch2010Optical,Vetsch2010Opticala,OShea2013,Goban2014,Grover2015,Lee2015,Beguin2014}, and a square waveguide, currently nanofabricated at Sandia National Laboratories~\cite{Jau2016Development,Lee2017Characterizations,Lee2013}.  For each geometry we study the use of the Faraday effect and polarimetry to perform a QND measurement of the magnetic spins, and thereby induce squeezing of collective spins of cesium atoms~\cite{Takahashi1999Quantum,Kuzmich1999,Kuzmich2000,Deutsch2010a,Smith2003a}.  Through the enhanced cooperativity, QND measurement can lead to substantial squeezing, greater than 10 dB in some geometries, for 2500 atoms.

The remainder of the paper is organized as follows.  In Sec. II we lay out the theoretical description of the QND measurement and the relevant measurement strength.  In addition, we describe how decoherence is included in the model through a first-principles stochastic master equation description.  From this we will see the cooperativity emerges as the key parameter that characterizes the squeezing.  We calculate in Sec. III the squeezing dynamics for the different nanophotonic waveguides, atomic preparations, and measurement protocols.  We conclude with a summary and outlook for future work.


%========================== Theory ===================================%
\section{QND measurement and cooperativity} \label{Sec::QNDandCooperativityTheory}
The theoretical framework describing the propagation of light guided in a nanofiber and interacting with trapped atoms in the dispersive regime is detailed in our previous work~\cite{Qi2016}.  We review the salient features here and include the generalization to a square waveguide.

For waveguides that are symmetric under a $\pi/2$ rotation around the $z$ (propagation) axis, there are two degenerate polarizations for each guided mode and for each propagation direction.  Assuming a nanophotonic waveguide that supports only the lowest order guided mode, and restricting our attention to modes propagating in the positive $z$-direction, we denote $\mbf{u}_H(\mbf{r}_\perp)$ and  $\mbf{u}_V(\mbf{r}_\perp)$ as the horizontally and vertically polarized modes that adiabatically connect to $x$ and $y$ linearly polarized modes as the cross section of the waveguide become large compared to optical wavelength.  Note, in typical nanophotonic geometries these guided modes also have a nonnegligible $z$ component.  For a cylindrically symmetric nanofiber, these are the well-studied HE$_{11}$ modes; for a square waveguide, these are the quasi-TE$_{01}$ and quasi-TM$_{01}$ modes, both shown in Fig.~\eqref{fig:nanofiberswg_E_ints}. One can solve for the guided modes of a cylindrical fiber analytically~\cite{Kien2004,Vetsch2010Opticala,Qi2016}. We use a vector finite difference method to numerically solve for the guided eigenmodes of the square waveguide~\cite{Fallahkhair2008} which has a core material of $ \rm{Si}_3\rm{N}_4 $ with an index of refraction $ 2 $ in this study~\cite{Lee2013}. These guided eigenmodes may also be solved as a linear combination of cylindrical harmonics based on the mode symmetry~\cite{Pavlovic2010Dispersion}.

\begin{figure}[htb]
\centering
  \begin{subfloat}[h][]{
    \centering
    \includegraphics[width=.49\textwidth]{fig/nanofiberswg_Hmode_E_xy}
    \label{fig:nanofiberswg_Hmode_E_xy} }
  \end{subfloat}\\%   
  \vspace{-30pt}
  \begin{subfloat}[h][]{
    \centering
    \includegraphics[width=.49\textwidth]{fig/nanofiberswg_Hmode_Ints_xy}
    \label{fig:nanofiberswg_Hmode_Ints_xy}}
  \end{subfloat}%  
  \vspace{-25pt}
  \caption{$H$-mode components (a) and intensity distribution (b) in the $ xy $-plane for the optical nanofiber and SWG. In \protect\subref*{fig:nanofiberswg_Hmode_E_xy}, shown on the first row from left to right are $ \mathrm{Re}[u_x(\br\!_\perp)] $, $ \mathrm{Re}[u_y(\br\!_\perp)] $ and $ \mathrm{Im}[u_z(\br\!_\perp)] $ of the nanofiber's $ H $-mode. White lines outline the waveguide boundary. The scale is normalized to the maximum value of all field components. Plots on the second row are the same components as the first row but for the SWG with the quasi-TE$_{01}$ as the $ H $-mode. All the other parts of the mode components not shown for both waveguide geometries vanish everywhere. In \protect\subref*{fig:nanofiberswg_Hmode_Ints_xy}, we plot the normalized intensity distribution on the transverse plane for both geometries. The arrows indicate the local field's direction and amplitude (relative length) at positions along the vertical waveguide axis, which only have an $ x $-component of the mode. The $ V $-mode is the $ H $-mode rotated by $ 90^\circ $ around the waveguide axis. }\label{fig:nanofiberswg_E_ints}
\end{figure}

The quasimonochromatic positive frequency component of the quantized field associated with these guided modes $(g)$ at frequency $\omega_0$ takes the form
\begin{align}\label{eq:Ebp}
\hat{\mathbf{E}}^{(+)}_g(\mbf{r}, t) &= \sqrt{ \frac{2 \pi \hbar \omega_0}{ v_g} } \left[\mathbf{u}_H(\mbf{r}\!_\perp)  \hat{a}_H(t) + \mathbf{u}_V(\mbf{r}\!_\perp) \hat{a}_V(t)\right]  e^{i (\beta_0 z- \omega_0 t)},
\end{align}
where $v_g$ is the group velocity.  In the first Born approximation the dispersive interaction of the guided field with $N_A$ atoms trapped near the surface of the waveguide at positions $\{\mbf{r}'_\perp, z_n\}$, detuned far from resonance,  is defined by the scattering equation,
\begin{equation}
\hat{\mathbf{E}}^{(+)}_{g,out}(\mbf{r}, t)=\hat{\mathbf{E}}^{(+)}_{g,in}(\mbf{r}, t)+\sum_{n=1}^{N_A} \tensor{\mbf{G}}_{g} (\mbf{r}, \mbf{r}'_n;\omega_0) \cdot \hat{\tensor{\alpha}}_n \cdot \hat{\mathbf{E}}^{(+)}_{g,in}(\mbf{r}'_n, t),
\end{equation}
where $\hat{\tensor{\alpha}}_n$ is the atomic polarizability operator of the $n^{th}$ atom, and 
\begin{equation}
		\tensor{\mathbf{G}}^{(+)}_g(\br,\br'_n; \omega_0) =  2\pi i \frac{\omega_0}{v_g } \sum_{p} \mathbf{u}_{p} (\br_\perp)\mathbf{u}^*_{p} 
(\br_{\perp}^\prime) e^{i \beta_0(z-z'_n)}  \label{Eq::GreensGuided}
\end{equation}
is the dyadic Green's function for a dipole to radiate into the forward propagating guided mode.  In principle the Green's function for a $N_A$-atom chain decomposes into a collective sub- and superradiant normal modes~\cite{Asenjo-Garcia2017Atom,Asenjo-Garcia2017Exponential}, but in the far-detuning limit, these all are equally excited.  The result is equivalent to the symmetric mode of independently radiating dipoles.  The input-output relation for the mode operators then reads
\begin{equation}
\hat{a}^{out}_p(t) = \hat{a}^{in}_p(t)  +i \sum_{p'} \hat{\phi}_{p,p'} \hat{a}^{in}_{p'}(t) ,
\end{equation}
where 
\begin{equation}
\hat{\phi}_{p,p'} = 2\pi \frac{\omega_0}{v_g} \mbf{u}^*_p (\mbf{r}'_\perp) \cdot \sum_{n=1}^{N_A} \hat{\tensor{\alpha}}_n \cdot \mbf{u}_{p'} (\mbf{r}'_\perp)
\end{equation}
is the phase operator associated with scattering polarization $p \rightarrow p'$ by a collective atomic operator.  When $p=p'$, this is a phase shift; for $p \neq p'$, this leads to a transformation of the polarization of the guided mode.

The Faraday effect arises from the irreducible rank-1 (vector) component of the polarizability tensor.  Given an atom with hyperfine spin $f$, this contribution is $\hat{\alpha}^{vec}_{ij} = i \alpha_1 \epsilon_{ijk} \hat{f}_k$, where $\alpha_1 = -\frac{\sigma_0}{4\pi k_0 }\frac{\Gamma_A}{\Delta_{\eff}} $ is the characteristic polarizability \comment{(need to unify the notation of $ \Gamma_A $'s)}, expressed here in terms of an effective on the detuning and resonant scattering cross section~\footnote{The exact expression is a sum of excited-state hyperfine levels $f'$, each weighted by the appropriate oscillator strengths of the transition.  We have defined $1/\Delta_{\eff} = \sum_{f'} C^{(1)}_{ff'}/\Delta_{ff'}$. For details see~\cite{Qi2016}}.   The polarization transformation associated with scattering from $H$ to $V$ mode is set by the phase operator
\begin{equation}
\hat{\phi}_{VH} = i 2\pi \frac{\omega_0}{v_g}\alpha_1 \left[ \mbf{u}^*_V (\mbf{r}'_\perp) \times  \mbf{u}_{H} (\mbf{r}'_\perp) \right] \cdot \hat{\mbf{F}},
\end{equation}
where $\hat{\mbf{F}}=\sum_n \hat{\mbf{f}}^{(n)}$ is the collective spin of the atomic ensemble.  Thus,
\begin{equation}\label{eq:aoutain}
\hat{a}^{out}_V(t) = \hat{a}^{in}_V(t)  +i  \hat{\phi}_{V,H} \hat{a}^{in}_{H}(t)= \hat{a}^{in}_V(t)  - 2\pi \frac{\omega_0}{v_g}\alpha_1 \left[ \mbf{u}^*_V (\mbf{r}'_\perp) \times  \mbf{u}_{H}\right(\mbf{r}'_\perp)]  \cdot \hat{\mbf{F}}\, \hat{a}^{in}_{H}(t),
\end{equation}
 and similarly for scattering from $V$ to $H$.

\begin{figure}[htb]
\centering
  \subfloat[b][]{
  \begin{minipage}[bt]{.88\textwidth}
    \centering
    \includegraphics[width=.98\textwidth]{fig/Fig_NanofiberSchematicFaraday}
    \label{fig:Fig_NanofiberSchematicFaraday}
    \end{minipage} }\\
  %\end{subfloat}\\%   
  \subfloat[b][]{
  \begin{minipage}[bt]{.5\textwidth}
      \centering
      \includegraphics[width=.45\textwidth]{fig/poincaresphere_initialS1_crystal}
      \label{fig:poincaresphere_initialS1_crystal}
   \hfill
        \centering
        \includegraphics[width=.45\textwidth]{fig/poincaresphere_initialS1_Faradayrot_crystal}
        \label{fig:poincaresphere_initialS1_Faradayrot_crystal}
   \vfill
    \centering
    \includegraphics[width=.45\textwidth]{fig/blochsphere_initialxFxyz_crystal_orange}
    \label{fig:blochsphere_initialxFxyz_crystal_orange}
   \hfill
      \centering
      \includegraphics[width=.45\textwidth]{fig/blochsphere_initialxFxyz_squeezed_crystal_orange}
      \label{fig:blochsphere_initialxFxyz_squeezed_crystal_orange}
  \end{minipage}}\hfill
  %\end{subfloat}% 
  \subfloat[b][]{
  \begin{minipage}[bt]{.45\textwidth}
        \centering
        \includegraphics[width=.98\textwidth]{fig/stretchedstatestransitions_dashline}
        \label{fig:stretchedstatestransitions}
    \end{minipage}}
    %\end{subfloat}
  \caption{Illustrated are the schematic polarization spectroscopy setup for the QND measurement and spin squeezing generation based on the Faraday effect (a), evolution of the light (top row of (b)) and collective spin states (bottom row of (b)) before and after the measurement, and the internal atomic state transitions in the optical pumping process (c). Diagram (a) is adapted from Ref.~\cite{Qi2016}.}\label{fig:spinsqueezingschematic}
\end{figure}

The polarization transformation can be expressed as a rotation of the Stokes vector of the light on the \Poincare sphere with operator components
\begin{subequations}\label{Eq::StokesComponents}
	\begin{align}
		\hat{S}_1(t) & = \smallfrac{1}{2}\big[ \hat{a}^\dag_H(t) \hat{a}_H(t)-\hat{a}^\dag_V(t) \hat{a}_V(t) \big], \\
	 	\hat{S}_2(t) & = \smallfrac{1}{2}\big[ \hat{a}^\dag_H(t) \hat{a}_V(t)+\hat{a}^\dag_V(t) \hat{a}_H(t) \big], \\ 
		\hat{S}_3(t) & = \smallfrac{1}{2i}\big[ \hat{a}^\dag_H(t) \hat{a}_V(t) -\hat{a}^\dag_V(t) \hat{a}_H(t) \big].
	\end{align}
\end{subequations}
By measuring the output Stokes vector in a polarimeter, we perform a QND measurement of a collective atomic operator to which it was entangled.  In a proper configuration, this leads to squeezing of a collective spin.  Launching $H$-polarized light corresponds to the initial Stokes vector along $S_1$, and Faraday rotation leads to an $S_2$ component, which is measured in a polarimeter (Fig.~\ref{fig:Fig_NanofiberSchematicFaraday}).  Taking the $H$-mode as a coherent state with amplitude $\beta_H$, the signal of the polarimeter measures $\hat{S}_2^{out} = (\beta_H \hat{a}_V^{\dag out} +\beta^*_H \hat{a}_V^{out})/2$.  Expressed in this way we see that the polarimeter acts as a homodyne detector, with the input $H$-mode acting as the local oscillator and the photons scattered into the $V$-mode as the signal.  Formally, the input-out relation follows from the scattering equations, Eq.~\eqref{eq:aoutain}, and reads
\begin{equation}
\hat{S}^{out}_2 = \hat{S}^{in}_2 +i \big( \hat{\phi}_{VH}- \hat{\phi}_{HV} \big) \hat{S}^{in}_1 =  \hat{S}^{in}_2 + \chi_3(\mbf{r}'_\perp) \hat{F}_z \hat{S}^{in}_1.
\end{equation}
The first term $\hat{S}^{in}_2$ represents the shot-noise that fundamentally limits the resolution of spin squeezing that can be obtained in a given time interval.  The second term is the homodyne signal, where we have expressed the rotation angle around the 3-axis of the \Poincare sphere as
\begin{equation}
\chi_3(\mbf{r}'_\perp) = -\frac{4 \pi \omega_0}{v_g} \alpha_1 \left\vert \text{Re} \left[ \mbf{u}^*_V (\mbf{r}'_\perp) \times \mbf{u}_H (\mbf{r}'_\perp) \right] \right\vert = \frac{\sigma_0}{A_{Far}(\mbf{r}'_\perp)} \frac{\Gamma_A}{2 \Delta_{\eff}}.
\end{equation}
We emphasize here the dependence of the rotation angle on the position of the atom in the transverse plane, $\mbf{r}'_\perp$, assumed equal for all atoms in the chain.  In particular $\chi_3(\mbf{r}'_\perp)$ depends on the {\em overlap} of the $\mbf{u}_H (\mbf{r}'_\perp)$ and $\mbf{u}_V (\mbf{r}'_\perp)$ , indicative of atomic scattering of photons from the $H$ to $V$ modes associated with the Faraday interaction.  We have characterized this overlap by an effective area that defines the Faraday interaction at the position of the atom,
\begin{equation}
\AF(\mbf{r}'_\perp) = \frac{1}{n_g \left\vert \text{Re} \left[ \mbf{u}^*_V (\mbf{r}'_\perp) \times \mbf{u}_H (\mbf{r}'_\perp) \right]\right\vert},
\end{equation}
where $n_g = v_g/c$ is the group index.  A more tightly confined (smaller) area corresponds to a stronger interaction.
%By ignoring the transition rate difference among the excited states in the same hyperfine manifold, the optimal choice of quantization axis is determined by the real cross production of the two orthogonal fundamental modes, $ \text{Re} \left[ \mbf{u}^*_V (\mbf{r}'_\perp) \times \mbf{u}_H (\mbf{r}'_\perp) \right] $. For both waveguide geometries we are interested in, or cylindrical waveguides in general, the real cross product of the modes and hence the optimal quantization $ z $-axis is along the waveguide axis or the $ z $-direction.

By monitoring the Faraday rotation, we can perform a continuous measurement on the collective spin projection $\hat{F}_z$.  The ``measurement strength'' which characterizes the rate at which we gain information and thereby squeeze the spin is given by
\begin{equation}
\kappa = \left\vert \chi_3(\mbf{r}'_\perp) \right\vert^2 \frac{P_{\rm in}}{\hbar \omega_0},
\end{equation}
where $P_{in}$ is the input power transported into the guided mode.  The measurement strength is the rate at which photons are scattered from the guided $H$ to $V$ mode.  Decoherence arises due to diffuse scattering into unguided modes and the accompanied optical pumping of the spin.  In principle the photon scattering rate into $4\pi$ steradians is modified over free space due to the Purcell effect, but we neglect this correction here.  In the case of the nanofiber, this is a small effect at typical distances at which the atom is trapped~\cite{LeKien2005,Kien2008}.  For the square waveguide, this may be nonnegligible; we will return to correction in future work.  The free-space diffuse photon scattering rate is given by
\begin{equation}
\gamma_s = \sigma(\Delta_{\eff}) \frac{I_{\rm in}(\mbf{r}'_\perp)}{\hbar \omega_0}
\end{equation}
where $\sigma(\Delta_{\eff}) = \sigma_0 \frac{\Gamma_A^2}{4 \Delta^2_{\eff}}$ is the photon scattering cross-section at this detuning and  $I_{\rm in}(\mbf{r}'_\perp) = n_g P_{\rm in}\vert \mbf{u}_H (\mbf{r}'_\perp)  \vert^2 \equiv P_{\rm in}/\Ai(\mbf{r}'_\perp) $ is the input intensity into the guided $H$-mode at the position of the atom, where we have defined
\begin{equation}
\Ai(\mbf{r}'_\perp) =  \frac{1}{n_g \vert \mbf{u}_H (\mbf{r}'_\perp) \vert ^2}
\end{equation}
to be the effective area associated with the input mode.  We thus define the cooperativity/atom
\begin{equation}
C_1 (\mbf{r}'_\perp)  = \frac{\kappa}{\gamma_s} = \sigma_0 \frac{  \Ai(\mbf{r}'_\perp) }{[\AF(\mbf{r}'_\perp)]^2}.
\end{equation}
This is the central result.  $\AF(\mbf{r}'_\perp)$  appears in the square because of the relation of the measurement strength to the homodyne measurement.  Roughly, $1/[\AF(\mbf{r}'_\perp)]^2 \sim \vert \mbf{u}_V (\mbf{r}'_\perp) \vert ^2 \vert \mbf{u}_H (\mbf{r}'_\perp) \vert ^2$, thus $ C_1(\mbf{r}'_\perp) \sim \sigma_0 \vert \mbf{u}_V (\mbf{r}'_\perp) \vert ^2$. In the context of homodyne measurement, the signal to be measured is proportional to the real overlap between the $ H $- and $ V $-modes, while the decoherence rate depends on the intensity of local oscillator or $ H $-mode. How large the initially {\em unoccupied} $ V $-mode is at the atoms' position determines the signal-to-noise ratio for a QND measurement.  We thus enhance the cooperativity by choosing the position of the atoms so that the {\em orthogonal}, unoccupied mode is large, while the intensity of the local input mode that causes decoherence is small.

In general, the cooperativity
\begin{align}\label{eq:c1_bound}
C_1(\mbf{r}'_\perp) = \sigma_0\frac{n_g \left\vert \text{Re} \left[ \mbf{u}^*_V (\mbf{r}'_\perp) \times \mbf{u}_H (\mbf{r}'_\perp) \right]\right\vert^2}{\vert \mbf{u}_H (\mbf{r}'_\perp) \vert ^2} \le \sigma_0n_g \vert \mbf{u}_V (\mbf{r}'_\perp) \vert ^2.
\end{align}
The equal sign is typically not achieved for a nanophotonic waveguide due to the out-of-phase $z $-component of the modes at arbitrary positions, while the upper bound naturally occurs in free-space, $ C_1=\frac{\sigma_0}{\Ai}=\sigma_0 u(r'_\perp)^2$ for Gaussian or plane transverse modes, where $ \vert \mbf{u}_H (\mbf{r}'_\perp) \vert ^2=\vert \mbf{u}_V (\mbf{r}'_\perp) \vert ^2 = u(r'_\perp)^2 $ independent of azimuthal angle. The upper bound may also be saturated with pure TEM modes of a waveguide when the longitudinal mode component vanishes. \comment{Even without pure transverse modes, however, as we will show next, by proper choice of the atomic position for the waveguide geometry, the cooperativity can be strongly enhanced over free space, due to the tight and anisotropic confinement of the modes the waveguide guides.}

\begin{figure}[htb]
\centering
 \begin{minipage}[h]{0.2\linewidth}
 %\begin{tabular}{*{2}{b{0.2\textwidth-2\tabcolsep}}}
  \subfloat[h][$1/\AF$]{
    %\input{fig/nanofiber_invA_Far_xy.tex}
    \includegraphics{fig/autofig/FaradayProtocol-figure0}
    \label{fig:nanofiber_invAFarxy}
    }
    \hfill
  \subfloat[h][$ 1/\Ain $]{
      \label{fig:nanofiber_invAin_xy}
      \includegraphics{fig/autofig/FaradayProtocol-figure1}
      %\input{fig/nanofiber_invA_in_xy.tex}
      }
   \end{minipage}\hfill
   \begin{minipage}[h]{0.75\linewidth}
   \subfloat[h][$ C_1 $]{
      \label{fig:nanofiber_C1_xy}
      \includegraphics{fig/autofig/FaradayProtocol-figure2}
      %\input{fig/nanofiber_C1_xy.tex}
      }
   \end{minipage}
   %\end{tabular}
\caption{Contour plots of the effective mode areas and the cooperativity per atom near an optical nanofiber. Subfigs.~\protect\subref*{fig:nanofiber_invAFarxy} and~\protect\subref*{fig:nanofiber_invAin_xy} show the contour of the reciprocal effective Faraday interaction mode area and the reciprocal input mode area in the $ xy $-plane, respectively. An $ x $-polarized incident mode is assumed. Subfig.~\protect\subref*{fig:nanofiber_C1_xy} shows the cooperativity contour plot in the $ xy $-plane. The isovalue lines of $ C_1 $ increase by $ 0.0777 $ on each gradient step from the outside inwards. }\label{fig:nanofiber_Aeffgeometry}
\end{figure}

\begin{figure}[htb]
\centering
 \begin{minipage}[h]{0.2\linewidth}
 %\begin{tabular}{*{2}{b{0.2\textwidth-2\tabcolsep}}}
  \subfloat[h][$1/\AF$]{
    %\input{fig/swg_invA_Far_xy.tex}
    \includegraphics{fig/autofig/FaradayProtocol-figure3}
    \label{fig:swg_invAFarxy}
    }
    \hfill
  \subfloat[h][$ 1/\Ain $]{
      \label{fig:swg_invAin_xy}
      \includegraphics{fig/autofig/FaradayProtocol-figure4}
      %\input{fig/swg_invA_in_xy.tex}
      }
   \end{minipage}\hfill
   \begin{minipage}[h]{0.75\linewidth}
   \subfloat[h][$ C_1 $]{
      \label{fig:swg_C1_xy}
      \includegraphics{fig/autofig/FaradayProtocol-figure5}
      %\input{fig/swg_C1_xy.tex}
      }
   \end{minipage}
   %\end{tabular}
\caption{Similar to Fig.~\ref{fig:nanofiber_Aeffgeometry} but for the SWG. In Subfig.~\protect\subref*{fig:swg_invAFarxy}, the contour lines outside of the waveguide are essentially concentric circles. There are distortions near the four corners of the SWG shown in the plot mainly caused by numerical divergences. In Subfig.~\protect\subref*{fig:swg_C1_xy}, the isovalue lines of $ C_1 $ increase by $ 0.164 $ on each gradient step from the outside inwards.}\label{fig:swg_Aeffgeometry}
\end{figure}

Figs.~\ref{fig:nanofiber_Aeffgeometry} and~\ref{fig:swg_Aeffgeometry} show plots of $1/\AF$, $1/\Ai$, and $C_1$ as a function of  $\mbf{r}'_\perp$ for the two nanophotonic geometries.  {\color{red} We see that $\AF$ is essentially cylindrically symmetric for both nanofiber and SWG geometries which have a $ C_4 $ rotation symmetry, and thus the measurement strength is basically independent of the azimuthal position of the atoms.}  In contrast $\Ai$ is azimuthally anisotropic.  $1/\Ai$ is the smallest along the $y$-axis at a given radial distance, which corresponds to the smallest intensity of the input $H$-mode, and thus smallest scattering rate $\gamma_s$.  This angle corresponds to the position at which $\vert \mbf{u}_V (\mbf{r}'_\perp) \vert$ is largest and thus yields the largest enhancement of $C_1$.  Thus, counterintuitively, we enhance the cooperativity by placing the atom at the angle of minimum input intensity.   This enhancement is even greater for the square waveguide which has more anisotropic guided modes compared to the cylindrical nanofiber.  For typical geometries, given a nanofiber with radius $a = 225$nm and atoms trapped at a radial distance $200$nm ($0.8a$) from the surface, the single atom cooperativity is $C_1 =0.23$ at the optimal trapping angle; for the square waveguide of width $w =300$nm, and atoms trapped $150$nm from the surface, $C_1 =0.32$ at optimum.  Thus with order 1000 trapped atoms the $N_A$-atom cooperativity is of order of $ 300 $, sufficient to generate substantial spin squeezing.

\section{Spin squeezing dynamics}

Given an ensemble of $N_A$ atoms initially prepared in a spin coherent state for the hyperfine spin $f$, polarized in the transverse plane, e.g., along the $x$-axis, a QND measurement of the collective spin  $F_z$ will squeeze the uncertainty of that component.  The metrologically relevant squeezing parameter~\cite{Wineland1992} is,
\begin{align}\label{eq:xi2Faraday}
\xi^2 &\equiv  \frac{2 N_A\expect{\Delta F_z ^2}}{f\expect{\hat{F}_x}^2}.
\end{align}
Under the assumption that the state is symmetric with respect to exchange of any two atoms, the collective expectation value can be decomposed into 
\begin{subequations}\label{eq:Ftof_squeezing}
\begin{align}
\expect{\Delta F_z^2} &= N_A \expect{\Delta f_z^2}+N_A(N_A-1)\left. \expect{\Delta f_z^{(i)}\Delta f_z^{(j)}}\right|_{i\neq j}\label{eq:DeltaFz2}\\
\expect{\hat{F}_x } & =N_A \expect{\hat{f}_x},\label{eq:expectFx}
\end{align}
\end{subequations}
where the first term of Eq.~\eqref{eq:DeltaFz2} and Eq.~\eqref{eq:expectFx} is the projection noise associated with the  $N_A$ identical spin-$f$  atoms, and  the second term of Eq.~\eqref{eq:DeltaFz2} is determined by two-body covariances, $ \left.\expect{\Delta f_z^{(i)}\Delta f_z^{(j)}}\right|_{i\neq j}=\expect{\Delta f_z^{(1)}\Delta f_z^{(2)}} = \expect{\hat{f}_z^{(1)}\hat{f}_z^{(2)}}-\expect{\hat{f}_z^{(1)}} \expect{\hat{f}_z^{(1)}} $.  Negative values in these two-body correlations correspond to the pairwise entanglement among atoms that yields spin squeezing~\cite{Wang2003Spin}.  Note that the collective state of atoms can be treated as pairwise-symmetric if the detuning is far-off resonance so that all collective sub- and super-radiant modes~\cite{Asenjo-Garcia2017Atom,Asenjo-Garcia2017Exponential} are equally (and thus symmetrically) excited.  In this paper, we work in the dispersive regime with a few thousands of atoms and can safely ignore the atom-atom interaction caused by multiple scattering, and hence the collective atomic system satisfy the exchange symmetry. 

To study the spin squeezing dynamics, we employ a first-principles stochastic master equation for the collective state of $N_A$ atoms,
\begin{align}\label{eq:totaldrhodt}
\mathrm{d}\hat{\rho}= \left.\mathrm{d}\hat{\rho}\right|_{QND}+\left.\mathrm{d}\hat{\rho}\right|_{op}.
\end{align}
The first term on the right-hand side of Eq.\eqref{eq:totaldrhodt} governs the spin dynamics arising from QND measurement,
\begin{align}
\left.\mathrm{d}\hat{\rho}\right|_{QND} &= \sqrt{\frac{\kappa}{4}}\mathcal{H}\left[\hat{\rho} \right]\mathrm{d}W + \frac{\kappa}{4}\mathcal{L}\left[ \hat{\rho}\right]\mathrm{d}t, 
\end{align}
where  $\kappa$ is the measurement strength defined in Eq. (?), and $\mathrm{d}W$ is a stochastic Weiner interval. The conditional dynamics are generated by superoperators that depend on the {\em collective} spin
\begin{subequations}
\begin{align}
\mathcal{H}\left[ \hat{\rho}\right] &= \hat{F}_z \hat{\rho} + \hat{\rho}\hat{F}_z -2\expect{\hat{F}_z}\hat{\rho}, \\
\mathcal{L}\left[ \hat{\rho} \right] &= \hat{F}_z \hat{\rho}\hat{F}_z -\frac{1}{2}\left(\hat{\rho}\hat{F}_z^2+\hat{F}_z^2\hat{\rho} \right)=\frac{1}{2}\left[\hat{F}_z,\left[\hat{\rho},\hat{F}_z \right] \right].
\end{align}
\end{subequations}
The second term governs decoherence arising from optical pumping, which acts {\em locally} on each atom$,\mathrm{d}\hat{\rho}|_{op}=\sum_i^{N_A} \mathcal{D}^{(i)}\left[ \hat{\rho}\right] \mathrm{d}t$, where 
\begin{equation}
\mathcal{D}^{(i)}\left[ \hat{\rho}\right] = -\frac{i}{\hbar}\left(\hat{H}^{(i)}_{\rm eff}\hat{\rho} - \hat{\rho} \hat{H}^{(i)\dag}_{\rm eff}\right) + \gamma_s\sum_q \hat{W}^{(i)}_q \hat{\rho}\hat{W}^{(i)\dag}_q.
\label{op_superator}
\end{equation}
Here $\hat{H}^{(i)}_{\rm eff}$ is the effective nonHermitian Hamiltonian describing the local light shift and absorption by the $i^{th}$ atom and $\hat{W}^{(i)}_q$ is the jump operator corresponding to optical pumping through spontaneous emission of a photon of polarization $q$~\cite{Deutsch2010a} (see Appendix~\ref{Sec::opticalpumpinginrotatingframe}).   
The rate of decoherence is characterized by the free space scattering rate, $\gamma_s$.  Note, optical pumping superoperator, Eq.\eqref{op_superator},  is not trace preserving when restricted to a given hyperfine manifold $f$.  In this case, optical pumping of atoms to the other hyperfine manifold in the ground-electronic state is treated as loss.  If the atoms are placed at the optimal angle, the local field is linearly polarized.  In that case the vector light shift vanishes, and for detunings large compared to the excited-state hyperfine splitting, the rank-2 tensor light shift is negligible.  In that case the light shift is dominated by the scalar component, which has no effect on the spin dynamics.  In that case $\hat{H}_{\rm eff} \propto -i\hbar \gamma_s 1$.

The solution to the master equation is made possible by three approximations. Firstly, we restrict the subspace of internal magnetic sublevels that participate in the dynamics.  The system is initialized in a spin coherent state, with all atoms spin-polarized along the $x$-axis.  We denote this as the ``fiducial state" $\ket{\uparrow} = \ket{f, m_x =f}$.   Through QND measurement, spin squeezing is induced by entanglement with the  ``coupled state"  $\ket{\downarrow} = \ket{f, m_x=f-1}$.  Optical pumping is dominated by ``spin flips" $\ket{\uparrow}\rightarrow \ket{\downarrow}$ and ``loss" due to pumping to the other hyperfine level.  We finally include a third internal magnetic sublevel $\ket{T} = \ket{f, m_x=f-2}$ to account for  ``transfer of coherences" that can occur in spontaneous emission~\cite{Norris2012Enhanced,Norris2014}.  Restricted to this qutrit basis with dimension $ d=3 $, the internal hyperfine spin operators are
\begin{subequations}\label{eq:fxfz_xbasis}
\begin{align}
\hat{f}_x &= -\left[f \hat{\sigma}_{\uparrow \uparrow} +(f-1) \hat{\sigma}_{\downarrow \downarrow} + (f-2)  \hat{\sigma}_{T T}\right], \\
\hat{f}_z &= \sqrt{\frac{f}{2}} \left(\hat{\sigma}_{\uparrow \downarrow} + \hat{\sigma}_{\downarrow \uparrow}\right) + \sqrt{\frac{2f-1}{2}}  \left(\hat{\sigma}_{\downarrow T} + \hat{\sigma}_{T \downarrow }\right),
\end{align}
\end{subequations}
where we have defined the atomic population and coherence operators $\hat{\sigma}_{ba}=\ket{b}\bra{a}$.

Secondly, we assume the collective state is symmetric under exchange of spins. This approximation is valid when all atoms see the same probe intensity (i.e., they are sufficiently cold) and in the far-detuning regime when all sub- and super-radiant modes are equally excited~\cite{Asenjo-Garcia2017Atom,Asenjo-Garcia2017Exponential}. With this, we can limit our attention to the symmetric subspace and define, for example, the symmetric two-body covariances by
\begin{align}
\expect{\Delta\sigma_{ba}^{(1)}\Delta\sigma_{dc}^{(2)}}_s \equiv \frac{1}{2}\left[\expect{\Delta\sigma_{ba}^{(1)}\Delta\sigma_{dc}^{(2)}}+\expect{\Delta\sigma_{ba}^{(2)}\Delta\sigma_{dc}^{(1)}} \right] ,
\end{align}
where the superscripts, $ ^{(1)} $ and $ ^{(2)} $, label arbitrary two atoms in the ensemble. Due to the exchange symmetry, $ \expect{\Delta\sigma_{ba}^{(1)}\Delta\sigma_{dc}^{(2)}}_s=\expect{\Delta\sigma_{ba}^{(1)}\Delta\sigma_{dc}^{(2)}}=\expect{\Delta\sigma_{ba}^{(2)}\Delta\sigma_{dc}^{(1)}} $, which reduces the number of $ n $-body moments required to simulate the spin dynamics of the ensemble.

Thirdly, we make the Gaussian approximation, valid for large atomic ensembles, so that the many-body state is fully characterized by one- and two-body correlations. Equivalently, the state is defined by the one and two-body density operators, with matrix elements $\rho^{(1)}_{a, b} =\expect{\hat{\sigma}_{ba}}$, $\rho^{(1,2)}_{ac,bd}=\expect{\Delta \sigma_{ba}^{(1)}\Delta\sigma_{dc}^{(2)} }_s$ in the symmetric subspace.   Optical pumping, acting locally, couple only $n$-body correlations to themselves, e.g.,
\begin{equation}\label{eq:dsigmabadc_op}
\left.d\expect{\Delta \sigma_{ba}^{(1)}\Delta\sigma_{dc}^{(2)} }_s\right|_{op} = \expect{\mathcal{D}^\dagger[\Delta \sigma_{ba}^{(1)}]\Delta\sigma_{dc}^{(2)} }_sdt + \expect{\Delta \sigma_{ba}^{(1)} \mathcal{D}^\dagger[\Delta\sigma_{dc}^{(2)}] }_sdt .
\end{equation}
QND measurement generates higher order correlations according to
\begin{equation}\label{eq:dsigmaba_QND}
\left.d\expect{\hat{\sigma}_{ba}}\right|_{QND} =\frac{\kappa}{4}\expect{\mathcal{L}^\dagger\left[\hat{\sigma}_{ba} \right]}dt + \sqrt{\frac{\kappa}{4}}\expect{\mathcal{H}^\dagger\left[\hat{\sigma}_{ba} \right]}dW .
\end{equation}
We can truncate this hierarchy in the Gaussian approximation, setting third order cumulants to zero.  Thus, for example,
\begin{align}
\left.d\expect{\Delta \sigma_{ba}^{(1)} \Delta \sigma_{dc}^{(2)}}_s \right|_{QND} &= \left.d\expect{\hat{\sigma}_{ba}^{(1)} \hat{\sigma}_{dc}^{(2)}}_s \right|_{QND} - \left. \expect{\hat{\sigma}_{ba}} \right|_{QND} \left( \left.d\expect{\hat{\sigma}_{dc}} \right|_{QND}\right) \nonumber\\
&\quad - \left. \expect{\hat{\sigma}_{dc}} \right|_{QND} \left( \left.d\expect{\hat{\sigma}_{ba}} \right|_{QND}\right)
- \left.d\expect{\sigma_{ba}} \right|_{QND}\left.d\expect{\sigma_{dc}} \right|_{QND} \nonumber \\
&= -\kappa\expect{\Delta \sigma^{(1)}_{ba}  \Delta F_z }_s \expect{\Delta F_z \Delta \sigma_{dc}^{(2)} }_sdt,\label{eq:dsigmabadc_QND}
\end{align}
where we have employed the Ito calculus $dW^2 = dt$.
Note, by setting the third-order cumulants to zero,  the contribution of the $\mathcal{L}$ superoperator to dynamics of the two-body covariances vanishes,  $ \left.d\expect{\Delta \sigma_{ba}^{(1)} \Delta \sigma_{dc}^{(2)}}_s\right|_\mathcal{L} =\frac{\kappa}{4}\expect{\mathcal{L}^\dagger\left[\Delta\sigma_{ba}^{(1)}\Delta\sigma_{dc}^{(2)} \right]}_sdt=0 $.  This indicates the events of no-photon detection under the Gaussian state approximation do not affect atom-atom correlations;  the measurement backaction and squeezing arise from the homodyne detection in the guided modes. 

Using all the approximations above, the collective spin dynamics can be efficiently calculated for the ensemble of $d=3$  qutrits with $ d^2=9 $ equations for the one-body quantity, $ \expect{\hat{\sigma}_{ba}} $, and $ d^2(d^2+1)/2=45 $ equations for the two-body covariances, $ \expect{\Delta \sigma_{ba}^{(1)}\Delta\sigma_{dc}^{(2)} }_s $, in the symmetric subspace independent of the number of atoms.
In general, to include the $ n $-body correlations, $ \sum_i^n\left(\!\begin{array}{c}i\\d^2\end{array} \! \right) $ equations are required and the formalism above can be extended to cut off the covariances at the $ (n+1)^{\text{th}} $ order. Despite the considerable number of equations required, the collective spin dynamics problem can still be efficiently solved because the coefficient matrices of the set of equations are almost diagonal and very sparse due to the $ \delta $-function-like selectivity of products of $ \hat{\sigma}_{ba} $ operators for arbitrary subscripts in the process of evolving the spin dynamics. Even better, for our problem, counting up to the two-body correlations (Gaussian state) is sufficient since we haven't reached the non-Gaussian state limit.

With this formalism in hand, we can calculate the squeezing parameter, Eq.\eqref{eq:xi2Faraday}, as a function of time by finding time-dependent solutions for the one-body averages $\expect{\hat{f}_x}$ and  $\expect{\Delta f_z^2}$, and the two-body correlations $\expect{\Delta f_z^{(1)} \Delta f_z^{(1)}}$ and hence the collective quantities in the Wiener process.  The detailed approach to calculating the collective spin dynamics can be found in Appendix~\ref{Sec::opticalpumpinginrotatingframe}. 

In Fig.~\ref{fig:xi_rpfix_NA_t}, we plot the reciprocal of the spin squeezing parameter as a function of time and its peak as a function of atom number, $ N_A $, for both optical nanofiber and the SWG cases. By placing atoms $ 200 $nm away from the nanofiber surface ($ r'\!_\perp=1.8a $), $ 7.1 $dB of squeezing may be achievable for $ 2500 $ atoms. This is a substantial enhancement when compared to the birefringence protocol of spin squeezing  studied in~\cite{Qi2016}, which showed a peak squeezing  of $ 4.7 $dB with the same set of experimental parameters. Using the SWG platform, on the other hand, with the same number of atoms placed $150 $nm away from the surface of the square waveguide, $13.5$dB of squeezing may be reachable. As we have shown in Sec.~\ref{Sec::QNDandCooperativityTheory}, the SWG geometry enhances the anisotropic contrast of the two orthogonal guided modes and dramatically reduces the relative local intensity when the atoms are placed on the $ y $-axis. This results in a large cooperativity, high peak spin squeezing , and a more stable spin squeezed state over the measurement period using the SWG compared to the nanofiber. Figs.~\ref{fig:nanofiber_peakxi_NA_rp1d8a} and~\ref{fig:swg_peakxi_NA_rp1d} show how the peak squeezing scales with more trapped atoms. Using the nanofiber, as along as the atom number is  $>1000 $, the peak  squeezing  is larger than in the birefringence protocol with $ 2500 $ atoms using similar trapping parameters. For the SWG case, even the number of trapped atoms is just above $ 600 $, $ >10 $dB of  squeezing is attainable. 

\begin{figure}[htb]
\centering
 \begin{minipage}[h]{0.95\linewidth}
 %\begin{tabular}{*{2}{b{0.2\textwidth-2\tabcolsep}}}
  \subfloat[h][$\xi^{-2}_{nanofiber}(t)$]{
    %\input{fig/nanofiber_xi_t_rp1d8a_NA2500.tex}
    \includegraphics{fig/autofig/FaradayProtocol-figure6}
    \label{fig:nanofiber_xi_t_rp1d8a_NA2500}
    }
    \hfill
  \subfloat[h][$ \xi^{-2}_{peak,nanofiber}(N_A) $]{
      \label{fig:nanofiber_peakxi_NA_rp1d8a}
      \includegraphics{fig/autofig/FaradayProtocol-figure7}
      %\input{fig/nanofiber_peakxi_NA_rp1d8a.tex}
      }
   \end{minipage}\vfill
   \begin{minipage}[h]{0.95\linewidth}
    %\begin{tabular}{*{2}{b{0.2\textwidth-2\tabcolsep}}}
     \subfloat[h][$\xi^{-2}_{swg}(t)$]{
       %\input{fig/swg_xi_t_rp1d_NA2500.tex}
       \includegraphics{fig/autofig/FaradayProtocol-figure8}
       \label{fig:swg_xi_t_rp1d_NA2500}
       }
       \hfill
     \subfloat[h][$ \xi^{-2}_{peak,swg}(N_A) $]{
         \label{fig:swg_peakxi_NA_rp1d}
         \includegraphics{fig/autofig/FaradayProtocol-figure9}
         %\input{fig/swg_peakxi_NA_rp1d.tex}
         }
   \end{minipage}
   %\end{tabular}
\caption{The inversed spin squeezing parameter as a function of time and atom number. Subfigs.~\protect\subref*{fig:nanofiber_xi_t_rp1d8a_NA2500} and~\protect\subref*{fig:swg_xi_t_rp1d_NA2500} are the time-dependent $ \xi^{-2} $ for the nanofiber and SWG, respectively. Similarly, Subfigs.~\protect\subref*{fig:nanofiber_peakxi_NA_rp1d8a} and~\protect\subref*{fig:swg_peakxi_NA_rp1d} are the plots of $ \xi^{-2} $ as a function of $ N_A $ correspondingly. }\label{fig:xi_rpfix_NA_t}
\end{figure}

{\color{red} In the absence of any other noise, the cooperativity of atom-light coupling increases as the atoms are placed closer to the waveguide surface. Figs.\ref{fig:nanofiber_peakxi_rp_NA2500} and~\ref{fig:swg_peakxi_rp_NA2500} show the peak squeezing  as a function of $ r\!_\perp $ for both nanofiber and SWG geometries with $2500$ atoms. With the same setting, we also plot out the cooperativity, $ C_1 $, in the logarithm scale in Figs.\ref{fig:nanofiber_C1_y} and~\ref{fig:swg_C1_y} as a function of atom radial distance to the center of both waveguide geometries. We find that $C_1$ is proportional to $ 1/r\!_\perp $ and the peak squeezing scales as $ \sqrt{OD} $ as expected. }


\begin{figure}[htb]
\centering
 \begin{minipage}[h]{0.95\linewidth}
 %\begin{tabular}{*{2}{b{0.2\textwidth-2\tabcolsep}}}
  \subfloat[h][$\xi^{-2}_{peak,nanofiber}(r\!_\perp)$]{
    %\input{fig/nanofiber_peakxi_rp_NA2500.tex}
    \includegraphics{fig/autofig/FaradayProtocol-figure10}
    \label{fig:nanofiber_peakxi_rp_NA2500}
    }
    \hfill
  \subfloat[h][$ C_1(r\!_\perp) $ of a nanofiber]{
      \label{fig:nanofiber_C1_y}
      \includegraphics{fig/autofig/FaradayProtocol-figure11}
      %\input{fig/nanofiber_C1_y.tex}
      }
   \end{minipage}\vfill
   \begin{minipage}[h]{0.95\linewidth}
    %\begin{tabular}{*{2}{b{0.2\textwidth-2\tabcolsep}}}
     \subfloat[h][$\xi^{-2}_{peak,swg}(r\!_\perp)$]{
       %\input{fig/swg_peakxi_rp_NA2500.tex}
       \includegraphics{fig/autofig/FaradayProtocol-figure12}
       \label{fig:swg_peakxi_rp_NA2500}
       }
       \hfill
     \subfloat[h][$ C_1(r\!_\perp) $ of a SWG]{
         \label{fig:swg_C1_y}
         \includegraphics{fig/autofig/FaradayProtocol-figure13}
         %\input{fig/swg_C1_y.tex}
         }
   \end{minipage}
   %\end{tabular}
\caption{Peak squeezing parameter (Subfigs.~\protect\subref*{fig:nanofiber_peakxi_rp_NA2500} and~\protect\subref*{fig:swg_peakxi_rp_NA2500}) and cooperativity (Subfigs.~\protect\subref*{fig:nanofiber_C1_y} and~\protect\subref*{fig:swg_C1_y}) as a function of the radial distance to the waveguide axis. \protect\subref*{fig:nanofiber_peakxi_rp_NA2500} and~\protect\subref*{fig:nanofiber_C1_y} are for the nanofiber case; Subfigs.~\protect\subref*{fig:swg_peakxi_rp_NA2500} and~\protect\subref*{fig:swg_C1_y} are for the SWG case. }\label{fig:peakxi_rp_NA}
\end{figure}


\section{Conclusion and outlook}
In this paper, we have studied the atom-light coupling based on Faraday interaction in the dispersive regime with application to QND measurement and spin squeezing with an ensemble of atoms. A set of stochastic master equations are derived by assuming the collective spins are symmetric Gaussian states while the simulations are performed in the qutrit internal subspace on a cylindrical nanofiber and a square waveguide platform, respectively. We proposed a protocol based on Faraday effect for precise QND measurement and strong spin squeezing by optimizing the cooperativity, which is defined as the measurement strength over the decoherence. Counterintuitively, the optimal geometry of measurement and trapping is such that atoms should be trapped at the minimal intensity spots of the probe in the transverse plane. With realistic parameters chosen, our simulation shows that larger than $ 7 $dB for the nanofiber or $ 10 $dB for the SWG of spin squeezing may be achievable with $ 2500 $ atoms. This proposed spin squeezing protocol based on Faraday effect has shown larger attainable squeezing effect over the birefringence-based spin squeezing protocol proposed in our earlier work~\ref{Qi2016}; meanwhile, compared to two-color spin squeezing protocol demonstrated in a recent experiment of QND measurement with a nanofiber~\cite{Beguin2017Observation}, this proposal simplifies the setup by fully utilizes the anisotropic property of the dielectric waveguide modes, and may also be able to reduce the mechanical oscillation of atoms due to the presence of the probe light by placing atoms at the weakest mode strength spots. 

Although we have only considered a cylindrical nanofiber and a square waveguide geometries, it is immediate applicable to use the idea of optimizing cooperativity with other nanophotonic waveguide geometries for a preciser QND measurement and stronger spin squeezing which are the key for atomic state readout and non-classical collective spin state preparation towards quantum information processing on a nanophotonic quantum interface~\cite{Qi2016}. 

As this work focuses on illustrating the significance of cooperativity in helping optimize waveguide-based QND measurement and spin squeezing protocols, we did not fully present the impact of Purcell effect and the modification of decay rates in our simulations which will further complicate this problem. We have neither considered the motion of atoms in the optical lattice for the same reason. In practice, however, these effects are important as having been observed in the nanofiber experiments~\cite{Solano2017Dynamics,Solano2017Alignment,Beguin2017Observation,Solano2017Optical}. We will include these effects in our future studies towards strategies of atom cooling and state initialization on these nanophotonic platforms. All data sets that have been used to generate the figures in this paper and the theory fully considering the polarization-dependent decay rates in the optical pumping process can be found in Ref.~\footnote{The URL and DOI will be provided before journal publication.} 

By the nature of the dispersive QND measurement and spin squeezing protocols, the probe light works preferably in the far-off-resonance regime where the photon scattering among atoms is negligible. For the completion of the theory of atom-light interactions on nanophotonic interfaces, it is necessary to include the collective effects due to photon scattering processes on general nanophotonic platforms, which will lead to the break of the symmetric state assumption which we have been used in our work~\cite{Qi2016} and will also inspire applications including quantum memories~\cite{Asenjo-Garcia2017Exponential,Asenjo-Garcia2017Atom} and the generation of matrix product states and cluster states~\cite{Economou2010,Lodahl2017Chiral,Schwartz2016Deterministic,Pichler2016Photonic,Pichler2017Photonic} based on the long-range interaction generated superradiance~\cite{Solano2017Super}, photonic delay lines and spin waves. The theoretical difficulty of studying these many-body effects lays down to the exponentially expanded Hilbert quantum space which cannot be stored efficiently on a classical computer. We hope the computational framework based on the $ n $-body moments will shadow a light on understanding the nature of quantum correlations and many-body interactions with an acceptable computational load. 

\section{Acknowledgments}
We thank the UNM Center for Advanced Research Computing for computational resources used in this work.
This work was supported by the NSF, under grants PHY-1212445, xxxxx.


\bibliography{refs/Archive}

%===============Appendix================= %
\begin{appendix}
\section{The computation of collective spin dynamics in details}\label{Sec::opticalpumpinginrotatingframe}
In this appendix, we will derive the stochastic equations from the static frame to the rotating frame and provide details on how we solve the spin dynamics based on the Faraday protocol with the waveguides discussed in the main text. 

The collective spin dynamics in the QND measurement and spin squeezing process is described by the stochastic master equation defined in Eq.~\eqref{eq:totaldrhodt}. The optical pumping dynamics of the $ j $-th atom are governed by 
\begin{align}\label{eq:op_master}
\left.\dt{\hat{\rho}^{(j)}}\right|_{op} &= \mathcal{D}[\hat{\rho}^{(j)}]=-\frac{i}{\hbar}\left(\hat{H}_{\rm eff}^{(j)}\hat{\rho}^{(j)} -\hat{\rho}^{(j)}\hat{H}_{\rm eff}^{(j)\dagger} \right) + \gamma_s\sum_{q}\hat{W}_q(\br'_j)\hat{\rho}^{(j)}\hat{W}_q^\dagger(\br'_j). %\\
%&=-\frac{1}{2}\sum_{a,b}\gamma_{ba}\ket{b}\bra{a}+
%\!\!\!\!\!\!\sum_{q,q',q'',a,b,c,d,f',f'',m',m''}\!\!\!\!\!\! \gamma_sw_{dcq}^{f''m''q''}\left(w_{abq}^{f'm'q'}\right)^*\ket{d}\bra{c}\hat{\rho}^{(i)}\ket{b}\bra{a}.
\end{align} 
We have defined a characteristic photon scattering rate, $\gamma_s \equiv \frac{\Gamma_A\Omega^2}{4\Delta_{F}^2}= \frac{\sigma_0}{A_{\rm in}}\frac{\Gamma_A^2}{4 \Delta_{F}^2} \dot{N}_L $ with an effective detuning $ \Delta_F $ defined by $ \frac{1}{\Delta_F}=\sum_{f'}\frac{C_{ff'}^{(1)}}{\Delta_{ff'}} $ and $ \Delta_{ff'}=\omega-\omega_{ff'} $, where $ \omega_{ff'} $ is the resonance frequency between $ \ket{j,f} $ and $ \ket{j',f'} $ levels.
We have also defined Rabi frequency $ \Omega=2\bra{j}|d|\ket{j'}\mathcal{E}^{(+)}_{\rm in}/\hbar $ with reduced optical dipole matrix element $\bra{j}|d|\ket{j'}$ and field amplitude $ \mathcal{E}^{(+)}_{\rm in}=|\mathbf{E}_{\rm in}^{(+)}(\br')| $.
%The total rate of photon scattering by an atom from the $\ket{a}\equiv \ket{f,f_x=a}$ to $ \ket{b}\equiv\ket{f,f_x=b} $ hyperfine ground state in the $x$-basis is
%	\begin{equation}\label{Eq::gammaf}
%		\gamma_{ba}=- \frac{2}{\hbar} {\rm Im} \big[ \bra{f,b} \hat{h}_{\rm eff}\ket{f,a} \big] ,
%	\end{equation}
In generating the plots for this paper, we have used a detuning of $1$nm from the $ \ket{j=1/2,f=4} $ to the $ \ket{j'=1/2,f'=3} $ transition on the lower energy side, which is much larger than the ac-Stark shifts, fine and hyperfine splittings of the excited state levels of the $ D_1 $-line transitions of $ ^{133} $Cs atoms. Therefore, the energy shifts between the hyperfine sublevels of the excited states become irrelevant to our calculation. 
We use the averaged decay rate $ \Gamma_{f'} $ over all possible polarizations of spontaneous emissions from the $ f' $ excited hyperfine manifold (see details later). 
The effective nonHermitian light-atom interaction Hamiltonian for one atom (labeled with superscript $ (i) $) is given by
\begin{align}
\hat{h}_{\rm eff}\equiv \hat{H}_{\rm eff}^{(i)} &= - \hat{\mathbf{E}}^{(-)}_{\rm in}(\mathbf{r}' ; t ) \cdot \poltens \cdot \hat{\mathbf{E}}^{(+)}_{\rm in}(\mathbf{r}' ;t ),
\end{align}
where $\charpol = -\frac{\sigma_0}{8\pi k_0\gamma_s}\frac{\Gamma_{f'}}{\Delta_{ff'}+i\Gamma_{f'}/2}$ is the complex polarizability and the polarizability operator $  \poltens=\sum_{f'}\charpol\hat{\tensor{\mathbf{A}}}(f,f')$ with elements of $ \hat{\tensor{\mathbf{A}}} $ given by
\begin{align} \label{Eq::PolarizabilityIrrep}
		\hat{A}_{ij}(f,f')&\equiv \hat{e}_i^*\cdot\hat{\mathbf{D}}_{ff'}\hat{\mathbf{D}}_{f'f}^\dagger \cdot \hat{e}_j \\
		&=  C_{ff'}^{(0)} \delta_{i,j}\hat{\mathbbm{1}}+ iC_{ff'}^{(1)}\epsilon_{ijk}\hat{f}_k+ C_{ff'}^{(2)} \Big[ \smallfrac{1}{2} ( \hat{f}_i\hat{f}_j +\hat{f}_j\hat{f}_i )-\smallfrac{1}{3} \hat{\mathbf{f}}\!\cdot\!\hat{\mathbf{f}} \delta_{i,j} \Big], 
\end{align}
where $\hat{\mathbf{f}}$ is the atomic spin operator in hyperfine multiplet $f$, and $ \epsilon_{ijk} $ is the Levi-Civita symbol. 
Definitions of the irreducible rank-$ K $ interaction coefficients $ C_{ff'}^{(K)} $ can be found in Refs.~\cite{Qi2016,Deutsch2010a}, which correspond to scalar, vector and tensor atom-light interactions for $ K=0,1,2 $, respectively.

Given the geometry of the Faraday spin squeezing protocol for optical nanofiber and square waveguides discussed in this paper, the local electric field at the atom positions is linearly polarized. 
By denoting the local field's polarization direction as the $ x$-direction and the propagation direction of the guided light as the $ z $-direction, the effective atom-light interaction Hamiltonian in a static reference frame can be written as 
\begin{align}
\hat{h}_{\rm eff} &= -\frac{i\hbar}{2}\sum_{f'} \gamma'_s \left[C_{ff'}^{(0)}\hat{\mathbbm{1}}+C_{ff'}^{(2)}(\hat{f}_{x}^2-\frac{\hat{\mathbf{f}}^2}{3} ) \right],
\end{align}
where the intrinsic photon scattering rate $ \gamma'_s\equiv \frac{\Gamma_{f'}\Omega^2}{4(\Delta_{ff'}^2+\Gamma_{f'}^2/4 )}$ and in the far-detuning regime, $\gamma'_s \approx \frac{\Gamma_{f'}\Omega^2}{4\Delta_{\rm eff}^2}=\frac{\sigma_0}{\Ain}\left(\frac{\Gamma_{f'}}{2\Delta_{\rm eff}} \right)^2\dot{N}_L $~\cite{Deutsch2010a}. Note here the vector interaction term vanishes given a linearly polarized light.
Compared to the normal characteristic photon scattering rate $ \gamma_s $, we can see they are defined in different scales.
In general, they are related for given $ f $ and $ f' $ by 
\begin{align}
\gamma'_s=\gamma_s \frac{\Delta_F^2}{\Delta_{ff'}},
\end{align}
and $ \frac{\sqrt{\Gamma_{f'}}\Omega/2}{\Delta_{ff'}\pm i\Gamma_{f'}/2}\approx \frac{\sqrt{\Gamma_{f'}}\Omega/2}{\Delta_{ff'}}=\sqrt{\gamma_s}\frac{\Delta_F}{\Delta_{ff'}} $ in the far-detuning regime.

We define the Lindblad jump operators of optical pumping among ground states by~\cite{Deutsch2010a}
	\begin{align}\label{Eq::Wq_Faraday}
		\hat{W}_q &= \frac{1}{\sqrt{\gamma_s}}\!\sum_{f'}\!\frac{\sqrt{\Gamma\!_{f'}}\Omega/2}{\Delta_{f\!f'} \!+\! i\Gamma\!_{f'}/2}\mathbf{e}_q^*\cdot(\hat{\mathbf{D}}_{f\!f'}  \hat{\mathbf{D}}^\dagger_{f'\!f} )\cdot\mathbf{e}_{\rm in} \\
		&= \frac{1}{\sqrt{\gamma_s}}\!\sum_{f'\!\!,\,k}\! \frac{\sqrt{\Gamma\!_{f'}}\Omega/2}{\Delta_{f\!f'}\!+\!i\Gamma\!_{f'}/2} \left[\!\delta_{qx}C_{f\!f'}^{(0)}\hat{\mathbbm{1}} \!+\! iC_{f\!f'}^{(1)}\epsilon_{qxk}\hat{f}_k \!+\! C_{f\!f'}^{(2)}\left(\frac{\hat{f}_q\!\hat{f}_{x}\!+\!\hat{f}_{x}\!\hat{f}_q }{2} \!-\! \frac{\delta_{qx}}{3}\hat{\mathbf{f}}^2 \right)\! \right].
%		&=\sum_{f',m',q',a,b} w_{baq }^{f'm'q'}\ket{b}\bra{a}.
	\end{align}
Each jump operator $\hat{W}_q$ is associated with absorption of the probe photon polarized along $ \mathbf{e}_{\rm in}=\mathbf{e}_x $ followed by spontaneous emission of a photon with polarization $ \mathbf{e}_q $, where $q= \{x,y,z\}$ labels the corresponding transitions in the Cartesian basis. 
%Here the dimensionless raising operator $ \mathbf{e}_q\cdot\hat{\mathbf{D}}_{f'f}^\dagger= \sum_{m',m} o_{jf}^{j'f'} C_{f',m'}^{f,m;1, q}\ket{f',m'}\bra{f,m} $,
%where $ C_{f',m'}^{f,m;1, q}=0 $ unless $ m'=m+q $ with $ C_{f',m+q}^{f,m;1, q}=\Braket{f',m+q}{f,m;1,q}$ being the Clebsch-Gordan coefficients, and
%\begin{equation}
%\big| o_{jf}^{j'f'} \big|^2=(2j'+1)(2f+2) \bigg\{
%\begin{array}{ccc}
%f' & 7/2 & j' \\
% j & 1 & f
% \end{array}
% \bigg\}
%\end{equation}
%are the relative oscillator strengths determined by the relevant Wigner 6-$J$ symbol.
%In our protocols, we assume the probe light is so far-detuned from any of the atomic resonances that the tilting of the hyperfine structure levels due to an external magnetic field becomes irrelevant and we can set $ \Delta_{ff'}^q=\Delta_{ff'} $ and $ \Delta_{ff'}\gg \Gamma_f'^q $ for arbitrary $ f' $ and $ q $.

Therefore, in the static $ \left\{x,y,z \right\} $ basis, we have
\begin{align}
\hat{W}_{x} &= \frac{1}{\sqrt{\gamma_s}}\!\sum_{f'} \frac{\sqrt{\Gamma_{f'}}\Omega/2}{\Delta_{ff'}+i\Gamma_{f'}/2} \left[C_{ff'}^{(0)}\hat{\mathbbm{1}} + C_{ff'}^{(2)}\left(\hat{f}_{x}^2-\frac{1}{3}\hat{\mathbf{f}}^2 \right) \right]\\
\hat{W}_{y} &= \frac{1}{\sqrt{\gamma_s}}\!\sum_{f'} \frac{\sqrt{\Gamma_{f'}}\Omega/2}{\Delta_{ff'}+i\Gamma_{f'}/2} \left(-iC_{ff'}^{(1)}\hat{f}_z + C_{ff'}^{(2)}\frac{\hat{f}_{x}\hat{f}_{y}+\hat{f}_{y}\hat{f}_{x}}{2} \right)\\
\hat{W}_{z} &= \frac{1}{\sqrt{\gamma_s}}\!\sum_{f'} \frac{\sqrt{\Gamma_{f'}}\Omega/2}{\Delta_{ff'}+i\Gamma_{f'}/2} \left(iC_{ff'}^{(1)}\hat{f}_{y} + C_{ff'}^{(2)}\frac{\hat{f}_z\hat{f}_{x}+\hat{f}_{x}\hat{f}_z}{2}  \right).
\end{align}

The atomic decay rates of the excited level $ e $ are modified due to the presence of the nanophotonic structure and can be given by
\begin{align}
\Gamma_e &= \sum_g \bra{e}\hat{\mathbf{d}}\ket{g} \cdot \mathrm{Im}\left[\tensor{\mathbf{G}}(\br',\br';\omega_{eg}) \right]\cdot \bra{g}\hat{\mathbf{d}}\ket{e}
\end{align}
with the dipole operator $ \hat{\mathbf{d}} $ and the total Green's function tensor as a combination of the contributions from the guided modes and radiative modes, $ \tensor{\mathbf{G}}(\br',\br';\omega_{eg})=\tensor{\mathbf{G}}_{gyd}(\br',\br';\omega_{eg})+\tensor{\mathbf{G}}_{rad}(\br',\br';\omega_{eg}) $.
Accordingly, the decay rates can also be decomposed into the guided and radiative modes components, or the total decay rates of a given level $ e $ can be calculated by $ \Gamma_e=\Gamma_{e,gyd}+\Gamma_{e,rad} $.
We calculate the guided mode Green's function tensor using the local guided modes following the eigenmode decomposition formula derived in Ref.~\cite{Qi2016}. Using a house-made program based on the \textit{boundary element method} (BEM) in the frequency domain~\cite{Abajo2002,GarciadeAbajo1998Relativistic}, the radiative Green's function tensor is calculated by simulating the local unguided modes emitted by an $i$-directed (for all $ i=x,y,z $) optical dipole placed near the waveguide. We set $ \Gamma_{f'}= \int \Gamma_{f'}(\theta,\phi)\frac{d\Omega}{4\pi}=(\Gamma_{f'}^x+\Gamma_{f'}^y+\Gamma_{f'}^z)/3=(\Gamma_{f'}^{\sigma_+}+\Gamma_{f'}^{\sigma_-}+\Gamma_{f'}^\pi)/3$ as the averaged value of decay rates over the $4\pi$ photon emission steradians for this study~\cite{Novotny2012} (see Fig.~\ref{fig:decayrates} for the decomposition of decay rates in the cylindrical basis). Using the mean-value decay rate approximation may cause some small errors in our simulations but is helpful to explain the idea of using cooperativity to design QND measurement and spin squeezing protocols. 

\begin{figure}[htb]
\centering
 \begin{minipage}[h]{0.4\linewidth}
 %\begin{tabular}{*{2}{b{0.2\textwidth-2\tabcolsep}}}
  \subfloat[h][$ \Gamma_{\rm nanofiber}/\Gamma_0 $]{
    %\input{fig/nanofiber_decayrates.tex}
    \includegraphics{fig/autofig/FaradayProtocol-Figure14}
    \label{fig:nanofiber_decayrates}
    }
   \end{minipage}\vfill
   \begin{minipage}[h]{0.4\linewidth}
    %\begin{tabular}{*{2}{b{0.2\textwidth-2\tabcolsep}}}
     \subfloat[h][$\Gamma_{\rm SWG}/\Gamma_0$]{
       %\input{fig/swg_decayrates.tex}
       \includegraphics{fig/autofig/FaradayProtocol-Figure15}
       \label{fig:swg_decayrates}
       }
   \end{minipage}
   %\end{tabular}
\caption{Polarization-dependent decay rates for the nanofiber \protect\subref*{fig:nanofiber_decayrates} and SWG \protect\subref*{fig:swg_decayrates} as functions of the radial distance to the waveguides' symmetric centers. Line types differ the contributions from the guided and radiative modes and the combined total value; colors distinguish the polarizations of $ \sigma_\pm $, $ \pi $ and the averaged case. }\label{fig:decayrates}
\end{figure}

    
Now, we consider a static magnetic field is applied to the atoms to fix the quantization axis to the $ \mathbf{e}_{z} $ direction pointing along the waveguide axis.
We assume the magnetic field is strong enough so that the Larmor processing is much faster than the atomic decay and atom-photon interaction processes.
In theory, this leads us to transfer the master equations describing the collective spin dynamics to the rotating frame determined by the fast-rotating transform operator
\begin{align}
\hat{U}_B(t) &= e^{-i\Omega_Bt\hat{f}_z},
\end{align}
where $ \Omega_B $ is the Larmor processing frequency of the external magnetic field.
In the rotating frame, a quantum operator $ \hat{A} $ is transferred into $ \hat{A}' $ through $ \hat{A}\rightarrow \hat{A}'=\expect{\hat{U}_B^\dagger\hat{A}\hat{U}_B }_T $, where the notation $ \expect{\cdot}_T=\frac{1}{T}\int\cdot dt $ is the time average of observables in the Larmor processing period $ T $.
The density operator preserves its form in the rotating frame.
We can solve the transformed master equations by employing the Baker-Campbell-Hausdorff formula that $ e^{\lambda\hat{A}}\hat{B}e^{-\lambda\hat{A}}=\sum_{n=0}^\infty\frac{\lambda^n}{n!}\hat{C}_n $, where $ \hat{C}_0=\hat{B} $ and $ \hat{C}_n=\left[\hat{A},\hat{C}_{n-1} \right] $ for $ n>1 $ and $ \left[\hat{f}_m, \hat{f}_n\right]=i\sum_p\epsilon_{mnp}\hat{f}_p $.
The following static-rotating frame transformation relationships can be proved easily:
\begin{subequations}\label{eq:rotationtransf}
	\begin{align}
	\hat{U}_B^\dagger\hat{f}_{x}\hat{U}_B&=\cos(\Omega_Bt)\hat{f}_x-\sin(\Omega_Bt)\hat{f}_y,\\
	\hat{U}_B^\dagger\hat{f}_{y}\hat{U}_B &= \sin(\Omega_Bt)\hat{f}_x+ \cos(\Omega_Bt)\hat{f}_y, \\ \hat{U}_B^\dagger\hat{f}_{z}\hat{U}_B &=\hat{f}_z,\quad \hat{U}_B^\dagger\hat{\mathbbm{1}}\hat{U}_B =\hat{\mathbbm{1}}.
	\end{align}
\end{subequations}
Operators with an odd order of transverse atomic angular momentum operator will be averaged to vanish. For example, $ \hat{f}_{x}=\hat{f}_{y} \rightarrow 0 $ and $ \hat{f}_{i=x,y}\hat{f}_{z}\rightarrow 0 $.


By using the transformation relationships of Eqs.\eqref{eq:rotationtransf} as well as relationships $ \hat{\mathbf{f}}^2=\hat{\mathbf{f}}\cdot\hat{\mathbf{f}}=f(f+1)\hat{\mathbbm{1}} $, $ \hat{f}_z =\sum_{m=1}^{2f+1}(f-m+1)\hat{\sigma}_{mm} $ and $ \hat{f}_z^2 = \sum_{m=1}^{2f+1}(f-m+1)^2\hat{\sigma}_{mm} $, the effective Hamiltonian and jump operators can be given in the rotating frame by 
\begin{subequations}
\begin{align}
\hat{h}_{\rm eff} &= -\frac{i\hbar}{2} \!\sum_{f'}\! \gamma'_s \!\sum_{m=-f}^f\!\left[C_{f\!f'}^{(0)} \!+\! \frac{C_{f\!f'}^{(2) }}{6}(f(f\!+\!1)\!-\!3m^2) \right]\hat{\sigma}_{mm}\\
\hat{W}_{x} &= \frac{1}{\sqrt{\gamma_s}}\!\sum_{f'}\! \frac{\sqrt{\Gamma\!_{f'} }\Omega/2}{\Delta_{f\!f'}\!+\!i\Gamma\!_{f'}/2 } \!\sum_{m=-f}^f\!\left[C_{f\!f'}^{(0)} \!+\! \frac{C_{f\!f'}^{(2) }}{6}(f(f\!+\!1)\!-\!3m^2) \right]\hat{\sigma}_{mm}\\
\hat{W}_{y} &= -\frac{i}{\sqrt{\gamma_s}}\!\sum_{f'}\! \frac{\sqrt{\Gamma\!_{f'} }\Omega/2}{\Delta_{f\!f'}\!+\!i\Gamma\!_{f'}/2 } \!\sum_{m=-f}^f\! C_{f\!f'}^{(1)}m\hat{\sigma}_{mm}\\
\hat{W}_z &=0.
\end{align}
\end{subequations}
After some algebra with the results above, one can find the optical pumping master equation in the rotating frame as
\begin{align}
\left. \dt{\hat{\rho}}\right|_{\rm op} 
&= - \sum_{f'} \gamma'_s \left[\left(C_{ff'}^{(0)}+\frac{f(f+1)}{12}C_{ff'}^{(2)} \right)\hat{\rho}-\frac{C_{ff'}^{(2)}}{4}(\hat{f}_z^2\hat{\rho}+\hat{\rho}\hat{f}_z^2) \right]\nn\\
&\quad+\sum_{f',f''} \frac{\sqrt{\Gamma_{f'}\Gamma_{f''} }\Omega^2/4 }{\Delta_{ff'}\Delta_{ff''}+\Gamma_{f'}\Gamma_{f''}/4+i(\Delta_{ff''}\Gamma_{f'}-\Delta_{ff'}\Gamma_{f''} ) }\nn\\
&\quad\cdot\left\{C_{ff'}^{(0)}C_{ff''}^{(0)}\hat{\rho}+ C_{ff'}^{(0)}C_{ff''}^{(2)}\frac{\hat{\rho}}{6}(\fo^2-3\hat{f}_z^2) + C_{ff''}^{(0)}C_{ff'}^{(2)}(\fo^2-3\hat{f}_z^2)\frac{\hat{\rho}}{6} \right.\nn\\
&\quad\quad + \frac{1}{2}C_{ff'}^{(1)}C_{ff''}^{(1)}(\hat{f}_x\hat{\rho}\hat{f}_x+\hat{f}_y\hat{\rho}\hat{f}_y+2\hat{f}_z\hat{\rho}\hat{f}_z )\nn\\
&\quad\quad -\frac{1}{4}C_{ff'}^{(1)}C_{ff''}^{(2)}(\fx\rhoo\fx-\fy\rhoo\fy-2i\fx\rhoo\fz\fy+2i\fy\rhoo\fx\fz )\nn\\
&\quad\quad +\frac{1}{4}C_{ff''}^{(1)}C_{ff'}^{(2)}(\fx\rhoo\fx-\fy\rhoo\fy-2i\fz\fy\rhoo\fx+2i\fx\fz\rhoo\fy ) \nn\\
&\quad +C_{ff'}^{(2)}C_{ff''}^{(2)}\left[\frac{1}{4}f^2(f+1)^2\rhoo-\frac{f(f+1)}{6}(\fo^2-\fz^2)\rhoo-\frac{f(f+1)}{6}\rhoo(\fo^2-\fz^2) \right.\nn\\
&\quad\quad\quad+\frac{1}{2}\fx^2\rhoo\fx^2+\frac{1}{2}\fy^2\rhoo\fy^2+\frac{1}{4}(i\fz+2\fy\fx)\rhoo(i\fz+2\fy\fx)\nn\\
&\left.\left.\quad\quad\quad +\frac{1}{8}(i\fy+2\fx\fz)\rhoo(i\fy+2\fx\fz)+\frac{1}{8}(i\fx+2\fz\fy)\rhoo(i\fx+2\fz\fy) \right]\right\}.\label{eq:drhodtop_rotating}
\end{align}
In our simulations, we use Eq.~\eqref{eq:drhodtop_rotating} as the master equation of the optical pumping process in the rotating frame and define the superoperator $ \mathcal{D} $ in Eq.~\eqref{eq:op_master} accordingly. Eq.~\eqref{eq:drhodtop_rotating} is valid as long as the decay rates are not too different from hyperfine sublevels of a given $ f' $ excited state quantum number compared to the detuning. We have also generalized this result to include the polarization-dependent modification of decay rates when the detuning is not very far from the transition resonance and validate the approximations used in this paper. 

As a sanity check, we consider the far-detuning regime where the detuning on hyperfine sublevels is indistinguishable so that we can denote $ f''$ as $f' $ and ignore all tensor polarizability terms wherever $ C_{ff'}^{(2)} $ presents in Eq.~\eqref{eq:drhodtop_rotating}, and the optical pumping part of the master equation above can be simplified as
\begin{align}\label{eq:op_fardetuning}
\left.\dt{\rhoo}\right|_{\rm op} = \gamma'_s \sum_{f'} \left[C_{ff'}^{(0)}(C_{ff'}^{(0)}-1)\rhoo+\frac{1}{2}(C_{ff'}^{(1)})^2(\fx\rhoo\fx+\fy\rhoo\fy+2\fz\rhoo\fz ) \right],
\end{align}
which is a well-known result published in previous studies~\cite{Deutsch2010a,Baragiola2014}.

Since the collective measurement operation is independent of the ensemble preparation, the form of the QND measurement superoperators $ \mathcal{H} $ and $ \mathcal{L} $ preserve their form in the rotating frame. With all the components of the stochastic master equation defined in Eq.~\eqref{eq:totaldrhodt} through Eq.~\eqref{op_superator}, one can derive the equations of motion of one- and two-body moments straightforwardly using the symmetric Gaussian state approximation. Some explicit results have been given in Eq.~\eqref{eq:dsigmabadc_op} through Eq.~\eqref{eq:dsigmabadc_QND}. The equation of motion for the optical pumping dynamics of the one-body moment $ \expect{\hat{\sigma}_{ba}} $, can be trivially given by
\begin{align}
\left.d\expect{\hat{\sigma}_{ba}}\right|_{op}&= \expect{\mathcal{D}^\dagger\left[\hat{\sigma}_{ba} \right]}dt=\sum_{c,d}\tr(\mathcal{D}^\dagger\left[\hat{\sigma}_{ba}\right]\hat{\sigma}_{dc} )\expect{\hat{\sigma}_{dc}}dt.\label{eq:dsigmaba_op_expand}
\end{align}
The last step is to project the expression onto the $ \expect{\hat{\sigma}_{dc}} $ qutrit basis ($ d,c\in \{\uparrow,\downarrow,T\} $) with coefficients defined in the trace form in the equation above. The equations of two-body moments of the optical pumping can be derived similarly. Continued from Eq.~\eqref{eq:dsigmabadc_op}, we have 
\begin{align}
\left.d\expect{\!\Delta \sigma_{ba}^{(\!1\!)}\Delta\sigma_{dc}^{(\!2\!)} }_s\right|_{op} &\!\!= \expect{\Delta\mathcal{D}^\dagger[ \sigma_{ba}^{(1)}]\Delta\sigma_{dc}^{(2)} }_sdt + \expect{\Delta \sigma_{ba}^{(1)} \Delta\mathcal{D}^\dagger[\sigma_{dc}^{(2)}] }_sdt\nn \\
&\!\!=\!\sum_{m,n}\! \tr\!\left(\mathcal{D}^\dagger[\hat{\sigma}_{ba} ]\hat{\sigma}_{mn} \right)\!\expect{\!\Delta\sigma_{mn}^{(\!1\!)}\Delta\sigma_{dc}^{(\!2\!)} }_s \!\!+\!\! \sum_{m,n}\!\tr\!\left(\mathcal{D}^\dagger[\hat{\sigma}_{dc}]\hat{\sigma}_{mn} \right)\!\expect{\!\Delta\hat{\sigma}_{ba}^{(\!1\!)}\Delta\sigma_{mn}^{(\!2\!)} }_s .\label{eq:dsigmabadc_op_expand}
\end{align} 
Similarly, Eqs.~\eqref{eq:dsigmaba_QND} and~\eqref{eq:dsigmabadc_QND} can be expanded easily by using $ \Delta F_z=\Delta \sum_i^{N_A} f_z^{(i)}=\sum_i^{N_A} \sqrt{\frac{f}{2}}(\Delta\sigma_{\uparrow\downarrow}^{(i)}+\Delta\sigma_{\downarrow\uparrow}^{(i)}) + \sqrt{\frac{2f-1}{2}}(\Delta \sigma_{\downarrow T}^{(i)}+\Delta\sigma_{T\downarrow}^{(i)}) $, where the subscription $ (i) $ can only be either $ (1) $ or $ (2) $ with $ 1 $ or $ N_A-1 $ copies depending on whether the $ \hat{\sigma}_{ba} $ operator is applied on the same atom as the other joint cumulants in the two-body moment variables. In deriving Eqs.~\eqref{eq:dsigmaba_QND} and~\eqref{eq:dsigmabadc_QND}, we have used the Gaussian state assumption to write three-body moments with one- and two-body moments by vanishing the corresponding third-order cumulants--that is to set, $ \expect{\Delta A\Delta B\Delta C }=\expect{(\hat{A}-\expect{\hat{A}} )(\hat{B}-\expect{\hat{B}})(\hat{C}-\expect{\hat{C}}) } =0$ or $ \expect{\hat{A}\hat{B}\hat{C}}=\expect{\hat{A}\hat{B}}\expect{\hat{C}}+ \expect{\hat{A}\hat{C} }\expect{\hat{B}}+\expect{\hat{B}\hat{C} }\expect{\hat{A}}-2\expect{\hat{A}}\expect{\hat{B}}\expect{\hat{C}} $. With all these tricks applied, Eqs.~\eqref{eq:dsigmaba_QND} and~\eqref{eq:dsigmabadc_QND} yield
\begin{align}\label{eq:dsigmaba_QND_expand}
\left.d\expect{\hat{\sigma}_{ba}}\right|_{QND} &=\frac{\kappa}{4}\sum_{c,d}\tr\left(\mathcal{L}^\dagger\left[\hat{\sigma}_{ba} \right]\hat{\sigma}_{dc}\right) \expect{\hat{\sigma}_{dc}}dt + \sqrt{\frac{\kappa}{4}}\sum_{c,d}\tr\left(\mathcal{H}^\dagger\left[\hat{\sigma}_{ba} \right]\hat{\sigma}_{dc}\right) \expect{\hat{\sigma}_{dc}}dW .
\end{align}
\begin{align}
\left.d\expect{\!\Delta \sigma_{ba}^{(\!1\!)}\! \Delta \sigma_{dc}^{(\!2\!)}}_s \right|_{QND} 
&\!\!= -\kappa\left\{\frac{1}{2}\left[ \sqrt{\frac{f}{2}}\left(\delta_{a\uparrow}\expect{\hat{\sigma}_{b\downarrow}}+ \delta_{b\downarrow}\expect{\hat{\sigma}_{\uparrow a}}+\delta_{a\downarrow}\expect{\hat{\sigma}_{b\uparrow}} +\delta_{b\uparrow}\expect{\hat{\sigma}_{\downarrow a} } \right)\right.\right.\nn\\
&\quad\quad\quad\quad\left. +\sqrt{\frac{2f-1}{2}}\left(\delta_{a\downarrow}\expect{\hat{\sigma}_{bT}} + \delta_{bT}\expect{\hat{\sigma}_{\downarrow a} }+\delta_{aT}\expect{\hat{\sigma}_{b\downarrow} } +\delta_{b\downarrow}\expect{\hat{\sigma}_{Ta} } \right)\right] \nn\\
&\quad\quad\quad -\sqrt{\frac{f}{2}}\expect{\hat{\sigma}_{ba} }\left(\expect{\hat{\sigma}_{\uparrow\downarrow} }+\expect{\hat{\sigma}_{\downarrow\uparrow} } \right) -\sqrt{\frac{2f-1}{2}} \expect{\hat{\sigma}_{ba}}\left(\expect{\hat{\sigma}_{\downarrow T}}+\expect{\hat{\sigma}_{T\downarrow}} \right)\nn\\ &\quad\quad\quad+(N_A-1)\left[\sqrt{\frac{f}{2}}\left(\expect{\Delta \sigma^{(1)}_{ba}  \Delta\sigma_{\uparrow\downarrow}^{(2)}}_s \!+\!\expect{\Delta\sigma_{ba}^{(1)}\Delta\sigma_{\downarrow\uparrow}^{(2)}}_s\right)\right.\nn\\
&\quad\quad\quad\quad\quad\quad\quad\quad\left.\left. + \sqrt{\frac{2f\!-\! 1}{2}}\left(\expect{\Delta \sigma^{(1)}_{ba}\Delta \sigma_{\downarrow T}^{(2)}}_s \!+\! \expect{\Delta\sigma_{ba}\Delta\sigma_{T\downarrow}^{(2)}}_s\right)\right]  \right\}\nn\\
&\quad\cdot\left\{ \frac{1}{2}\left[ \sqrt{\frac{f}{2}}\left(\delta_{c\uparrow}\expect{\hat{\sigma}_{d\downarrow}}+ \delta_{d\downarrow}\expect{\hat{\sigma}_{\uparrow c}}+\delta_{c\downarrow}\expect{\hat{\sigma}_{d\uparrow}} +\delta_{d\uparrow}\expect{\hat{\sigma}_{\downarrow c} } \right)\right.\right.\nn\\
&\quad\quad\quad\quad\left. +\sqrt{\frac{2f-1}{2}}\left(\delta_{c\downarrow}\expect{\hat{\sigma}_{dT}} + \delta_{dT}\expect{\hat{\sigma}_{\downarrow c} }+\delta_{cT}\expect{\hat{\sigma}_{d\downarrow} } +\delta_{d\downarrow}\expect{\hat{\sigma}_{Tc} } \right)\right] \nn\\
&\quad\quad -\sqrt{\frac{f}{2}}\expect{\hat{\sigma}_{dc} }\left(\expect{\hat{\sigma}_{\uparrow\downarrow} }+\expect{\hat{\sigma}_{\downarrow\uparrow} } \right) -\sqrt{\frac{2f-1}{2}} \expect{\hat{\sigma}_{dc}}\left(\expect{\hat{\sigma}_{\downarrow T}}+\expect{\hat{\sigma}_{T\downarrow}} \right)\nn\\
&\quad\quad + (N_A-1)\left[ \sqrt{\frac{f}{2}} \left(\expect{\Delta\sigma_{\uparrow\downarrow}^{(1)}\Delta\sigma_{dc}^{(2)}}_s \!+\!\expect{\Delta\sigma_{\downarrow\uparrow}^{(1)}\Delta \sigma_{dc}^{(2)}}_s\right)\right. \nn\\
&\quad\quad\quad\quad\quad\quad\quad\left.\left. + \sqrt{\frac{2f\!-\! 1}{2}}\left(\expect{\!\Delta \sigma_{\downarrow T}^{(\!1\!)}\Delta\sigma_{dc}^{(\!2\!)}}_s \!+\!\expect{\!\Delta\sigma_{T\downarrow}^{(\! 1\! )} \Delta \sigma_{dc}^{(\!2\!)} }_s\right)\!\right]\!  \right\}dt,\label{eq:dsigmabadc_QND_expand}
\end{align}
Eventually, by combining the optical pumping and QND measurement parts of the Eqs.~\eqref{eq:dsigmaba_op_expand} through~\eqref{eq:dsigmabadc_QND_expand}, one can find a set of stochastic equations of a closed set of variables of $ \left\{\expect{\hat{\sigma}_{ba}},\expect{\Delta\sigma_{ba}\Delta\sigma_{dc} }_s\left|a,b,c,d\in \{\uparrow,\downarrow,T \}\right. \right\} $ in the symmetric qutrit subspace. All the coefficients in these equations can be numerically calculated on a computer, and turn out to be very sparse and close to diagonal which indicates only nearest neighboring coupling is possible in the $\left\{\expect{\hat{\sigma}_{ba}},\expect{\Delta\sigma_{ba}\Delta\sigma_{dc} }_s\right\}$ basis. To respect the nature of the exchange symmetry in two-body moment variables, we label $ \hat{\sigma}_{ba} $ as $ \hat{\sigma}_i $ with $ i=1,2,\cdots, 9 $ for $ b$ and $a  $ counting from $ (\uparrow,\downarrow,T) $ qutrit state labels; the two-body moment variables can then be ordered in the symmetric subspace as $ \expect{\Delta\sigma_i\Delta\sigma_j} $ given $ j\ge i $ to represent $ \expect{\!\Delta \sigma_{ba}^{(\!1\!)}\! \Delta \sigma_{dc}^{(\!2\!)}}_s $ satisfying $ \expect{\!\Delta \sigma_{ba}^{(\!1\!)}\! \Delta \sigma_{dc}^{(\!2\!)}}_s=\expect{\!\Delta \sigma_{dc}^{(\!1\!)}\! \Delta \sigma_{ba}^{(\!2\!)}}_s $ under the exchange symmetry. In the symmetric qutrit subspace, we have $ 45 $ two-body moment variables and corresponding sparse second-order equations. Also note that $ n $-body moment equations of motion can be derived in a similar manner using this approach to include quantum correlations beyond Gaussian state approximation, and can be solved efficiently due to the sparse nature of the coupled equations. It may also be possible to calculate two-time correlations and \textit{out-of-time-correlators} using this approach with quantum regression theorem~\cite{Swingle2016Measuring,Swain1981Master}.

To calculate up to two-body moments, we treat the system to have only two atoms, and initially each atom is prepared in the $ \ket{\Psi}=\ket{\uparrow}_x $ state. Then the initial value of $ \expect{\hat{\sigma}_{ba} } $ and $ \expect{\Delta\sigma_i\Delta\sigma_j}=\expect{\Delta\sigma_{ba}\Delta\sigma_{dc}}_s $ at time $ t=0 $ can be given by
\begin{subequations}
\begin{align}
\expect{\hat{\sigma}_{ba}(0)}&=\bra{\Psi}\hat{\sigma}_{ba}\ket{\Psi}\\
\expect{\Delta\sigma_i\Delta\sigma_j(0)} &= (\bra{\Psi}\otimes\bra{\Psi})\frac{\hat{\sigma}_{ba}^{(1)} \otimes\hat{\sigma}_{dc}^{(2)}+\hat{\sigma}_{dc}^{(1)} \otimes\hat{\sigma}_{ba}^{(2)}}{2}(\ket{\Psi}\otimes\ket{\Psi})\nn\\
&\quad-\bra{\Psi}\hat{\sigma}_{ba}\ket{\Psi}\bra{\Psi}\hat{\sigma}_{dc}\ket{\Psi}.
\end{align}
\end{subequations}
With the initial values and equations of motion given above, the stochastic time evolution of the one- and two-body moments can then be solved by evolving the equations from the initial value to arbitrary time $ t $ in a Wiener process. The collective spin squeezing dynamics can be fully described by the set of $ \{\expect{\hat{\sigma}_{ab}},\expect{\Delta\sigma_{dc}\Delta\sigma_{ba}}\} $ observables, and the spin squeezing parameter (Eq.~\eqref{eq:xi2Faraday}) can be calculated using the relationships between the collective spin quantities, $ \expect{\hat{F}_x} $ and $ \Delta F_z^2 $, and the one- and two-body moments in the following formulas. 
\begin{subequations}
	\begin{align}
	\expect{\hat{F}_x} &= \sum_i^{N_A}\expect{\hat{f}_x}\nonumber\\
	&= -N_A \left[f\expect{\sigmauu}+(f-1)\expect{\sigmadd}+(f-2)\expect{\sigmatt } \right]\label{eq:Fx_qutrit}\\
	\expect{\Delta F_z^2} &= N_A\expect{\Delta f_z^2} + N_A(N_A-1)\expect{\Delta f_z^{(1)}\Delta f_z^{(2)} }_s\nn\\
	&=N_A\left\{ \frac{f}{2}\left(\expect{\sigmauu}+\expect{\sigmadd}-2\expect{\sigmaud}\expect{\sigmadu}-\expect{\sigmaud}^2-\expect{\sigmadu}^2 \right)\right. \label{eq:DeltaFz2_fz}\\
	&\quad\quad+ \frac{2f-1}{2}\left(\expect{\sigmadd}+\expect{\sigmatt}-2\expect{\sigmadt}\expect{\sigmatd}-\expect{\sigmadt}^2-\expect{\sigmatd}^2 \right)\nn\\
	&\quad\quad +\left. \frac{\sqrt{f(2f-1)}}{2}\left[\expect{\sigmaut }+\expect{\sigmatu} -2\expect{\sigmaud}(\expect{\sigmadt}+\expect{\sigmatd}) -2\expect{\sigmadu}(\expect{\sigmadt}+\expect{\sigmatd} ) \right] \right\}\nn\\
	&\quad +N_A(N_A-1)\left[\frac{f}{2}(\expect{\Dsigmaud^{(1)}\Dsigmaud^{(2)} }_s +2\expect{\Dsigmaud^{(1)}\Dsigmadu^{(2)} }_s+\expect{\Dsigmadu^{(1)}\Dsigmadu^{(2)} }_s )\right. \label{eq:DeltaFz2_qutrit}\\
	&\quad\quad + \frac{2f-1}{2}(\expect{\Dsigmadt^{(1)}\Dsigmadt^{(2)} }_s +2\expect{\Dsigmadt^{(1)}\Dsigmatd^{(2)} }_s +\expect{\Dsigmatd^{(1)}\Dsigmatd^{(2)} }_s) \nn\\
	&\quad\quad + \left. \sqrt{f(2f-1)}(\expect{\Dsigmaud^{(1)}\Dsigmadt^{(2)} }_s +\expect{\Dsigmaud^{(1)}\Dsigmatd^{(2)} }_s +\expect{\Dsigmadu^{(1)}\Dsigmadt^{(2)} }_s+\expect{\Dsigmadu^{(1)}\Dsigmatd^{(2)} }_s )\right],\nn
	\end{align}
\end{subequations}
where we have used Eqs.~\eqref{eq:Ftof_squeezing} and~\eqref{eq:fxfz_xbasis}. Eq.~\eqref{eq:DeltaFz2_fz} indicates spin squeezing is generated by spin-spin correlations of the local measurement observables due to the collective measurement, while Eq.~\eqref{eq:DeltaFz2_qutrit} gives the detailed microscopic correlation expansion in the qutrit subspace.

Our spin dynamics simulation results have been verified in the far-detuning regime against Eq.~\eqref{eq:op_fardetuning} and against the approximate equations of motions of one- and two-moments defined explicitly using the collective operators $ \hat{N}_A $ and $ \hat{F}_i $ ($ i=x,y,z $) following the derivation process introduced in Refs.~\cite{Qi2016} and~\cite{Norris2014}.



\end{appendix}
\end{document}
